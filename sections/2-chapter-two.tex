% \section{Вторая глава}
% \label{cha:ch_2}

% \subsection{Auxiliary techniques}
% \subsubsection{Synthetic aperture array}

% Antenna movement gives opportunities to apply synthetic aperture for AOA
% estimation \cite{cite37,cite38}. In this case time samples can be presented as
% outputs of some antenna array and any AOA estimation technique can be applied
% for them. In case of uniform linear movement we can write the following
% equation.
% \begin{equation}
%     y(m) = A \exp{2\pi f_0 frac{v}{c} \sin \phi T m},
% \end{equation}
% $A$ -- комплексная амплитуда; 
% $f_0$ -- несущая частота; 
% $v$ -- скорость устройства; 
% $c$  -- скорость света;
% $T$ -- период измерений;
% $\phi$ -- AOA, $m$ -- дискретное время.

% \begin{figure}[ht]
%     \centering
%     \includegraphics[width=0.6\linewidth]{example-image-a}
%     \caption{Антенна с синтезированной апертурой}
%     \label{fig:3.19}
% \end{figure}

% \section{}

\section{Теория}
\subsection{Ограничения и мотивации}
% As the performance of mmWave system depends on beamforming accuracy, the primary task of the
% stage is to develop a precise AOA estimation algorithm. The considered problem has a set of
% significant restrictions which we have taken into account in our research.

Поскольку производительность системы mmWave зависит от точности формирования луча, основная задача
этой работы заключается в разработке точного алгоритма оценки АОА. Рассматриваемая задача имеет множество
существенных ограничения, которые учитываются в этом исследовании.

\begin{enumerate}
    %     \item The AOA estimation algorithm should work using reference signals of NR standard. Thus, it
    % has to use a quite inflexible time structure. Moreover, the algorithm depends on BS’s beam
    % sounding strategy, which is fixed for some reference signals (e.g. a series of DFT-based
    % beams applied by BS during the SS burst).
    \item Алгоритм оценки AOA должен работать на пилотных сигналах стандарта NR. Таким образом, \textit{он
              должен использовать весьма негибкую временную структуру}. Кроме того, алгоритм зависит от луча БС.
          стратегия зондирования, которая фиксируется для некоторых эталонных сигналов (например, ряд основанных на ДПФ
          лучи, применяемые БС во время вспышки СС).
          %     \item SS burst is more preferable reference signal as it does not exploit additional resources.
          % It is desired to use common reference signals for all users, i.e. BS’s cannot use adaptive
          % sounding strategy.
          % User equipment has a single digital port only and beams are formed in analog domain. Thus,
          % some UE’s sounding strategy has to be used.
    \item \textit{SS burst является более предпочтительным эталонным сигналом}, так как он не использует дополнительные ресурсы.

    \item Желательно использовать общие опорные сигналы для всех пользователей, т.е. БС не могут использовать адаптивные
          стратегия звучания.
          Пользовательское оборудование имеет только один цифровой порт, а лучи формируются в аналоговой области. Таким образом,
          необходимо использовать некоторую стратегию звучания УЭ.

    \item Пользовательское оборудование поддерживает формирование диаграммы направленности с помощью фазовращателей. \textit{Нет свободы амплитуды
              степени в векторе формирования луча}.

    \item При переключении луча возникает проблема со скачком фазы. Это значительно
          усложняет когерентный прием для разных лучей и требует некоторого аппаратного решения
          и калибровки. \textit{Таким образом, необходимо сосредоточиться на методах, основанных на мощности, где фаза сигнала
              не измеряется}.

    \item Пользовательская антенная система состоит из \textit{нескольких независимых решеток, которые нельзя использовать
              одновременно}. Каждая решетка покрывает только часть возможных АОА.

    \item Алгоритм должен быть простым.
\end{enumerate}

На основе проведенного обзора литературы (см. \ref{sec:references:review}) мы выделили и разработали
несколько подходов, отвечающих вышеперечисленным требованиям. Первый подход, в качестве базового алгоритма был выбран иерархический поиск (см. \ref{hierarchy:search}).
Это простейший метод, который аппроксимирует алгоритм Фурье (оптимальное решение в случае однолучевого канала) адаптивным дискретным образом.
Основной проблемой этого алгоритма будет ошибка квантования.  В данной работе разработан новый алгоритм, основанный на концепции иерархического поиска. Он использует улучшенную схему измерения и обеспечивает
оценку без ошибки квантования на основе критерия минимума среднеквадратичной ошибки (MMSE).

Второй рассматриваемый алгоритм основан на моноимпульсе, идея которого была предложена в
\cite{Zhu2016, Kim2019}, но только для одной антенной решетки. В данной работе этот алгоритм тестировался и модифицировался под выбранную аппаратную конфигурацию.
Этот алгоритм также обеспечивает непрерывный результат.

Последний рассмотренный алгоритм, так называемый \textit{Adaptive Compressed Sensing Algorithm}, который был предложен в \cite{Alkhateeb2014} для системы HBF (Чё это?)
Этот алгоритм представляет собой схему бинарного поиска со специально разработанной кодовой книгой. Это одно из самых простых и эффективных решений, среди подобных алгоритмов.
Кроме того, он основан исключительно на мощностных характеристиках принятого сигнала.
Однако описанное решение и кодовая книга подойдут только для очень больших антенных решеток
со степенями свободы как по фазе, так и амплитуде. Для выбранной конфигурации, описанное в \cite{Alkhateeb2014} нельзя применить напрямую, поэтому алгоритм пришлось модицицировать.
Основным преимуществом этого алгоритма является сокращение времени зондирования.

Все упомянутые выше улгоритмы были модицицированы для оценки многолучевого AOA.

Далее мы приведем подробное описание алгоритмов, схем измерений и результатов
моделирования.

\subsection{Описание системы и предположения}
\subsubsection{Структура пилотных сигналов}

Стандарт 5G NR включает два типа опорных сигналов, которые можно использовать для обучения луча: SS-burst
и CSI-RS.

SS-burst представляет собой специальный набор опорных сигналов -- блоков синхронизации (SS blocks), предназначенных для
первоначального доступа. Пилотные сигналы занимают полосу в 127. Каждый блок синхронизации
передается с уникальным весовым вектором. То есть только одна пара лучей пользователя и базовой станции может быть прозвонена за один SS блок.
FR2 (mmWave) максимальное количество SS блоков в SS-burst равно 64. SS-burst повторяются с периодом, находящимся  в диапазоне от 5 до 160 мс \cite{Dahlman2018}.
Мы рассматриваем значение по умолчанию 20 мс.

\begin{figure}[h!]
    \centering
    \includegraphics[width=0.4\linewidth]{figs/fig4.1}
    \caption{Структура блока синхронизации}
    \label{fig:4.1}
\end{figure}
\begin{figure}[h!]
    \centering
    \includegraphics[width=\linewidth]{figs/fig4.2}
    \caption{Последовательность блоков синхронизации (SS-burst)}
    \label{fig:4.2}
\end{figure}

\subsubsection{Пользовательская система антенных решеток}

В данной работе разрабатываются алгоритмы для системы, состоящей из двух линейных эквидистантных антенных решеток, расположенных на противоположных сторонах
устройства (см. \ref{fig:4.3}). В данной конфигурации оборудования, у пользователя нет слепых зон в азимутальной плоскости.

Система содержит только один цифровой порт. Таким образом, решетки не могут
использоваться одновременно и возможно только переключение между ними.

Формирование ДН происходит с помощью непрерывных независимых аналоговых фазовращателями, как показано
на \ref{fig:4.4}.  Диаграмма направленности каждого антенного элемента устанавливается в
соответствии с таблицей 7.3-1 стандарта 3GPP TR 38.901. Ширина луча по уровню -3
дБ составляет $65^\circ$, усиление составляет 8 дБи, ослабление мощности с задней стороны решетки составляет
-30 дБ, поляризация предполагается вертикальной.

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.5\linewidth]{figs/fig4.3}
    \caption{Расположение антенных решеток на мобильном устройстве}
    \label{fig:4.3}
\end{figure}


\begin{figure}[ht]
    \centering
    \includegraphics[width=0.4\linewidth]{figs/fig4.4}
    \caption{}
    \label{fig:4.4}
\end{figure}

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.75\linewidth]{figs/fig4.5}
    \caption{Локальная система координат пользователя}
    \label{fig:4.4}
\end{figure}


Также стоит определить что мы подразумеваем под угловой координатой источника излучения. Поскольку выбранная антенная решетка линейна, она не может измерять одновременно азимутальный угол и угол места принятого излучения.
Однако, линейная решетка может определить обобщенный угол $\psi$. Тогда мы можем рассматривать некоторый эффективный азимутальный угол $\phi_{eff}$ в качестве угловой координаты источника, который удовлетворяет следующему уравнению
\begin{equation}
    \label{eq:4.1}
    \psi = 2\pi \frac{d}{\lambda} \sin \phi_{eff} = 2\pi \frac{d}{\lambda} \sin\phi \cos{\theta},
\end{equation}
\begin{equation}
    \label{eq:4.2}
    \phi_{eff} = \arcsin(\sin \phi \cos \theta),
\end{equation}
где $\phi$ и $\theta$ -- геометрические углы азимута и элевации источника.

\subsubsection{Антенная решетка базовой станции и система прозвонки}

Антенная решетка базовой станции представляет собой эквидистантную плоскую антенную решетку с 12 строками и 16 столбцами.
Есть два цифровых порта. Формирование диаграммы направленность происходит независимыми непрерывными аналоговыми фазовращателями. Таким образом, можно одновременно
прозвонить два луча, если это позволяет структура пилотного сигнала.

Диаграмма направленности антенного элемента устанавливается в соответствии с
таблицей 7.3-1 стандарта 3GPP TR 38.901. Ширина луча элемента по уровню $-3$ дБ составляет
$65^\circ$. Усиление составляет 8 дБи, ослабление мощности с задней стороны решетки составляет
-30 дБ, поляризация предполагается вертикальной.

В результате, мы имеем 192 пары ортогональных лучей для этой антенный решетки. Однако мы не сможем прозвонить их все за один SS-burst (см. \ref{SS-burst}), поскольку
нам доступно только 64 возможных прозвонки. Для решения этой проблемы учтем два факта.
Во-первых, пользователи в пространстве перемещаются больше в горизонтальной
плоскости, чем в вертикальной. Поэтому можно увеличить ширину луча в
вертикальной плоскости и уменьшить количество лучей с различными углами
элевации.
Во-вторых, в mmWave системе пользователи обычно распологаются ниже БС, поэтому
лучи соответствующие верхнему подпространству БС могут не рассматриваться.

Тогда, проблема решается следующим образом:
\begin{itemize}
    \item Верхние 4 ряда антенной решетки БС отключаются (см. \ref{fig:4.5}), обеспечивая более широкую ДН в вертикальной плоскости
    \item Кодовая книга БС выбирается на основе БФП (см. \ref{codebook}). Горизонтальная сетка обобщенных углов $-\pi + pi/16:\pi/8:\pi-\pi/16$.
          Горизонтальная сетка обобщенных углов $-3\pi/4:\pi/4:0$.
    \item Представленная кодовая книга покрывает нижнюю половину пространства (см. \ref{fig:4.6}), где, как ожидается, будет находиться пользователь.
\end{itemize}

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.35\linewidth]{figs/fig4.5}
    \caption{Серые элементы антенной решетки отключены во время оценки угла прихода}
    \label{fig:4.6}
\end{figure}

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.5\linewidth]{figs/fig4.6}
    \caption{ДН антенной решетки БС в вертикальной плоскости}
    \label{fig:4.7}
\end{figure}


\subsection{Оценка мощности}
Поскольку разрабатываемые алгоритмы должны быть основаны на мощности, ключевым
моментом является способ измерения мощности сигнала. Для каждой пары лучей UE-BS
у нас есть набор пилотных поднесущих, поэтому у нас есть два пути:
\begin{enumerate}
    \item Усреднить мощность по всем пилотным поднесущим
    \item Использовать Фурье преобразование по всем пилотным поднесущим, перейти от частотной характеристики канала к временной и оценить мощность как максимум импульсной характеристиках канала
\end{enumerate}

Возьмем для начала однолучевую модель канала. В этом случае сигнал, принятый на $q$-ой пилотной поднесущей примет вид
\begin{equation}
    x_q = a e^{-i2\pi q\Delta f \tau} + \xi_q,
\end{equation}
где $a$ амплитуда луча, включающая в себя диаграмму направленность элемента, $\Delta f$ расстояние между пилотными поднесущими в частотной области, $\tau$ -- задержка распространения, $\xi$ -- белый гауссовый шум с мощностью $\sigma^2$.
Для первого варианта, оцененная мощность примет вид
\begin{equation}
    \hat p_1 = \frac{1}{Q} \sum\limits_{q = 0}^{Q - 1} \abs{x_q}^2,
\end{equation}
где $Q$ -- число пилотных поднесущих. После несложных вычислений, можем получить
\begin{equation}
    \mean{\hat p_1} = \abs{a}^2 + \sigma^2.
\end{equation}
\begin{equation}
    D_1 = \mean{p_1^2} - \mean{p_1}^2 = \frac{1}{Q}\qty(2\abs{a}^2 \sigma^2 + \sigma^4),
\end{equation}
где $\mean{\dots}$ -- математическое ожидание, $D$ -- дисперсия оценки мощности.



Во всех алгоритмах нас будет интересовать $\abs{a}^2$ или пропорциональная ей величина.
Относительная систематическая ошибка $\delta_{s1}$ и относительная случайная ошибка $\delta_{r1}$ равны
\begin{equation}
    \delta_{s1} = \frac{\mean{\hat p_1} - \abs{a}^2}{\abs{a}^2} = \frac{\sigma^2}{\abs{a}^2},
\end{equation}
\begin{equation}
    \delta_{r1} = \frac{\sqrt{D_1}}{\abs{a}^2} =
    \frac{1}{\sqrt{Q}} \sqrt{2 \frac{\sigma^2}{\abs{2}} +
        \frac{\sigma^4}{\abs{a}^4}},
\end{equation}

Для второго варианта, оцененная мощность будет вычисляться следующим образом
\begin{equation}
    \hat p^2 = \max_n(\frac{1}{Q} \sum\limits_{q=0}^{Q-1} x_q e^{-2 \pi q n /Q})^2,
\end{equation}
где $n$ -- индекс в оцененной дискретной ИХ канала. Если предположить, что выбор максимума всегда осуществляется корректно, можно получить следующее
\begin{equation}
    \mean{\hat p_2} = \abs{a}^2 F + \frac{1}{Q}\sigma^2.
\end{equation}
\begin{equation}
    D_2 = \mean{\hat p_2^2} - \mean{\hat p_2}^2 = \frac{2\abs{a}^2 F \sigma^2}{Q},
\end{equation}
\begin{equation}
    F = \max_n \frac{\sin^2[\pi Q (\Delta f \tau - n/Q)]}{Q^2 \sin^2[\pi(\Delta f \tau - n/Q)]},
\end{equation}
\begin{equation}
    \frac{4}{\pi^2} \leq \frac{1}{Q^2 \sin^2[\frac{\pi}{2Q}]} \leq F \leq 1,
\end{equation}


Таким образом, мы видим, что оценка мощности также смещена, но систематическая
ошибка меньше, чем в первом случае.
Так как любой постоянный коэффициент $F$ не важен в алгоритмах, а
лишь обеспечивает дополнительный выигрыш во временной области, относительную
систематическую ошибку $\delta_{s2}$ и относительную случайную ошибку $\delta_{r2}$ следует
определять как
\begin{equation}
    \delta_{s2} = \frac{\mean{\hat p_2} - F \abs{a}^2}{F \abs{a}^2} = \frac{1}{Q} \frac{\sigma^2}{F\abs{a}^2},
\end{equation}
\begin{equation}
    \delta_{r2} = \frac{\sqrt{D_1}}{F\abs{a}^2} = \frac{1}{\sqrt Q} \sqrt{\frac{2\sigma^2}{F\abs{a}^2}}.
\end{equation}

Если мы используем только пилотные поднесущие для оценки мощности и $FQ > 1$ (т.е. $Q\geq 3$),
мы можем гарантировать, что $\delta_{s2} \leq \delta{s1}$. Поэтому, второй подход к оценке дает меньшую
систематическую ошибку. Что касается случайной ошибки, мы можем сказать, что $\delta_{r_2} \leq \delta_{r_1}$, если
$\abs{^2}/\sigma^2 < 0.34$ (т.е. SNR на поднесущую составляет -4.7 дБ или меньше).

Таким образом, второй подход к оценке мощности для алгоритма AuxBeam и случаев с
низкими SNR. Также, если задачей является оценка угла на основной луч в
многолучевом канале, второй подход уменьшает помехи, вызванными остальными лучами.
Однако в случае многолучевой оценки угла прихода второй подход приводит к
высокой сложности, поскольку мы должны рассматривать трехмерную задачу для
каждого пути распространения.

Таким образом, в работе применеются следующая схема оценки мощности
\begin{enumerate}
    \item Для оценки угловой координаты в однолучевом канале, мы применяем второй подход (TOA selection) \\
    \item Для оценки угловой координаты в многолучевом канале, мы применяем перывй подход (усреднение принятой мощности по пилотным поднесущим) \\
\end{enumerate}

\section{Однолучевые алгоритмы оценки угла прихода сигнала}
\subsection{Базовый алгоритм}
Эффективность базового алгоритма, также будем называть его \textit{baseline}, рассматривается как нижняя граница разработанных алгоритмов.
Первоначально базовый алгоритм рассматривался нами как полный перебор по всем парам лучей (UE-BS), примененный к эволюционировавшему во времени каналу.
Однако он дает слишком высокую ошибку дискретизации и сравнивать с ним результаты других алгоритмов оказалось не наглядно. Поэтому в дальнейшем в этой работе под базовым алгоритмом будет пониматься
алгоритм иерархического поиска. Алгоритм состоит из двух этапов: полного перебора всех пар лучей UE-BS и процедуры уточнения.
На первом этапе пользователь использует ортогональную кодовую книгу, покрывающую диапазон углов от $-\pi$ до $\pi$:
\begin{equation}
    \vec w_u =
    \begin{bmatrix}
        1 & \exp {i \eta_u} & \dots & \exp{i(N-1)\eta_u}
    \end{bmatrix}^T
\end{equation}
\begin{equation}
    \eta_u = -\pi \frac{N-1}{N} + 2\pi \frac{u-1}{N},
\end{equation}
где $N$ -- число элементов антеннйо решетки, $u$ -- индекс весового вектора, лежащий в интервале $\qty[1 \dots N]$, $\eta_u$ -- обобщенный угол, соответствующий углу прихода сигнала следующим образом
\begin{equation}
    \eta_u = 2\pi \frac{d}{\lambda_w}\sin\phi_u,
\end{equation}
где $d$ -- расстояние между элементами решетки, $\lambda_w$ -- длина волны. ДН,
получаемые с помощью данной кодовой книги показаны на рис. \ref{fig:4.9}
сплошными линиями.
\begin{figure}[ht]
    \centering
    \includegraphics[width=0.5\linewidth]{figs/fig4.9}
    \caption{Различные ДН, формируемые кодовой книгой на стороне пользователя. $\psi$ -- обобщенный угол, $N=8$, $M=4$}
    \label{fig:4.9}
\end{figure}

Пусть $v$ -- индекс наилучшего весового вектора $\vec w_u^{(v)}$, который обеспечивает наибольшую принятую мощность на антенной решетке.
Соответствующая ДН показана на рис. \ref{fig:4.9} толстой спложной линией. Пусть $p_v$ -- мощность, измеренная для вектора $\vec w_u^{(v)}$. На этапе процедуры уточнения
пользователь тестирует $M$ дополнительных весовых векторов, чтобы уменьшить ошибку дискретизации.
\begin{equation}
    \label{eq:4.19}
    \vec w_q =
    \begin{bmatrix}
        1 & \exp {i \chi_q} & \dots & \exp{i(N-1)\chi_q},
    \end{bmatrix}^T
\end{equation}
\begin{equation}
    \chi_q = \eta_v + 2\pi \frac{q}{N(M+1)},
\end{equation}
где $q=-0.5M,\dots,-1,+1,\dots,+0.5M$. Сформированные дополнительные ДН показаны на рис.\ref{fig:4.9} пунктирными линиями.

Мы можем положить $p_0= p_v$ и $\chi_0 = \eta_v$. Отметим, что для процедуры уточнения не нужно проводить измерения $\chi_0$, поскольку оно уже было сделано на предыдущем этапе.
Наонец, путь распространения с обобщенным углом $\hat \psi$ оценивается как один из $\chi_q \in \qty{\chi_{-0.5 M}, \dots, \chi_0, \dots, \chi_{+0.5M}}$,
обеспечивающий наибольшую измеренную мощность $p_q$. Угол прихода соответствующего луча оценивается как
\begin{equation}
    \hat \phi = \arcsin{\frac{\psi \lambda_w}{2\pi d}}.
\end{equation}

Процедура измерения алгоритма представлена на рис. \ref{fig:4.10} и происходит следующим образом:
\begin{enumerate}
    \item Sector Level Sweep Stage. BS periodically sweeps its beams. UE
          sequentially uses each beam of codebook (4.16) to measure power for each
          beam of BS. This procedure is performed for AIP1 and AIP2
    \item We choose the best UE-BS beam pair and consider the selected UE’s
          beam as the best sector with spatial frequency $\eta_v$.
    \item Refinement procedure stage. BS periodically sweeps its beams. UE
          sequentially uses each beam of codebook (4.19) to measure power for each
          beam of BS.
    \item We choose the best UE-BS beam pair among all measured at step 3 and
          measured for the central beam of the best sector at step 1. The spatial
          frequency of the selected UE’s beam is $\hat \psi$.
          %  \item If the best UE-BS beam pair is related to AIP1, $\hat \phi_{AOA} = \hat \phi$ 
          %  determined in (4.21).  If the best UE-BS pair is related to AIP2, φ ̂_AOA=φ
          %  ̂+ π. The result is obtained in radians.
\end{enumerate}

\begin{figure}[ht]
    \centering
    \includegraphics[width=\linewidth]{figs/fig4.9}
    \caption{Изображение процедуры иерархического поиска (baseline) во времени для двух антенных решеток. $N=8$, $M=4$, 64 луча BS}
    \label{fig:4.9}
\end{figure}

Параметры алгоритма иерархического поиска представлены в таблице \ref{tab:4.2}.
Предполагается, что один SS-burst состоит из 64 RS и занимает 32 последовательных слота с периодом 20 мс.

\begin{table}
    \caption{Параметры алгоритма иерархического поиска (baseline)}
    \label{tab:4.2}
\end{table}


\subsection{Иерархический поиск с минимизацией СКО}
В теории оценивания AOA доказано, что наилучшее решение дает максимально правдоподобная оценка (Maximum Likelihood Estimator).
Рассматривая случай однолучевого канала, можно представить уравнение \eqref{eq:3.10} в виде
\begin{equation}
    d(\phi) = \sum\limits_q \vec y^H(q) \vec y(q) - \sum\limits_q\abs{\vec y^H \vec s(\phi)}^2 \to \min_\phi,
\end{equation}
\begin{equation}
    \label{eq:4.23}
    \sum\limits_q \abs{\vec y^H(q) \vec s(\phi)}^2 = \hat p(\phi) \to \max_\phi,
\end{equation}
где $\vec y$ -- вектор принятого антенной решеткой сигнала, $\vec s(\phi)$ --
диаграммобразующий вектор. Выражение \eqref{eq:4.23} имеет смысл мощности,
принимаемой с  вектором $\vec s(\phi)$, обеспечивающим максимум ДН в направлении
$\phi$. Максимизация этого значения есть ни что иное, как непрерывное
сканирование лучом и получение пространственного распределения мощности.

На практике, мы не можем применить этот оптимальный алгоритм по нескольким
причинам. Во-первых, мы управляем лучами дискретными фазовращателями и можем
оценить только дискретный спектр мощности. Разумеется, можно применить некоторые
методы интерполяции, но это будет только приближение.  Во-вторых, у нас есть
сильные ограничения по времени, особенно в случае динамического канала.  Таким
образом, метод иерархического поиска, который адаптивно измеряет дискретный
спектр мощности, представляется наиболее подходящей аппроксимацией оптимального
ML-оценки.  Однако, приближение спектра мощности с помощью иерархического
поиска, каким он рассматривался в предыдущем разделе \eqref{sec:hierarchy}, не
является удачной аппроксимацией.  Прежде всего потому что это приближение с
ошибкой дискретизации. К тому же, если искомая угловая координата источника
лежит на стыке  двух антенных решеток $\hat \phi \approx \pm \pi$ или же просто
при низком SNR,  можно ошибиться с выбором антенной решетки и эта ошибка не
будет исправлена в дальнейшем. С учетом этим недостатков, был разработан
улучшенный алгоритм иерархического поиска.

На первый взгляд, проблема дискретизации может быть решена с помощью
ML-оценки, адаптированного к последовательному измерению отклика мощности
луча. Однако полученная в этом случае функция правдоподобия сложна для анализа
(здесь предполагается, что амплитуда принимаемого сигнала имеет распределение
Райса).

\begin{equation}
    F_{ML}(\psi, a) = \prod\limits_m \frac{1}{\sigma^2}
    \exp{-\frac{\hat p_m + a f_m(\psi)}{\sigma^2}
        I_0\qty(\frac{2\sqrt{\hat p_m a f_m(\psi)}}{\sigma^2})} \to \max_{\psi, a},
\end{equation}
где $\hat p_m$ -- измеренная мощность на $m$-ом луче, $\sigma^2$ -- мощность
шума, $a$ -- "мощность" некоторого путя распространения, $I_0(x)$ --
модицицированная функция Бесселя, $f_m(\psi)$ -- усиление АР для $m$-го луча в
направлении обобщенного угла $\chi_m$, $\psi = 2\pi \frac{d}{\lambda_w}\sin
    \phi$ -- обобщенный угол, а $\phi$ -- угол прихода.
\begin{equation}
    f_m(\psi) = \frac{\sin^2 (0.5N(\psi - \chi_m))}{\sin^2(0.5(\psi - \chi_m))}.
\end{equation}
Поскольку мы пытаемся найти простое решение, мы предлагаем взять в основу критерий минимума СКО, вместо ML-оценки.
\begin{equation}
    \label{eq:26}
    F_{MMSE}(\psi, a) = \sum\limits_m \qty(\hat p_m - a f_m(\psi))^2 \to \min_{\psi,a}
\end{equation}

В первую очередь, необходимо исключить параметр $a$ из уравнения \eqref{eq:26}.
\begin{equation}
    \pdv{a} F_{MMSE}(\psi, a) = \sum\limits_m 2f_m(\psi) (\hat p_m - a f_m(\psi)) = 0
\end{equation}
\begin{equation}
    a(\psi) = \qty[\sum\limits_m f_m(\psi) \hat p_m][\sum\limits_m f_m^2(\psi)]^{-1}.
\end{equation}
Тогда, окончательный результат
\begin{equation}
    F_{MMSE}(\psi)=\underbrace{\sum\limits_m \hat p_m^2}_{\const} - \qty[\sum\limits_m f_m(\psi) \hat p_m]^2 \qty[\sum \limits_m f_m^2 (\psi)]^{-1} \to \max_{\psi}
\end{equation}
\begin{equation}
    \label{eq:4.30}
    F(\psi)=\qty[\sum\limits_m f_m(\psi) \hat p_m]^2 \qty[\sum \limits_m f_m^2 (\psi)]^{-1} \to \max_{\psi}
\end{equation}
На рис. \ref{fig:4.10} представлен вид функции \eqref{eq:4.30} во время процедуры уточнения для точной оценки угла прихода.

\begin{figure}[htbp]
    \begin{subfigure}{0.49\linewidth}
        \centering
        \includegraphics[width=\linewidth]{figs/fig4.10a}
        \caption{}
        \label{fig:4.10a}
    \end{subfigure}
    \begin{subfigure}{0.49\linewidth}
        \centering
        \includegraphics[width=\linewidth]{figs/fig4.10b}
        \caption{}
        \label{fig:4.10b}
    \end{subfigure}
    \caption{ \subref{fig:4.11a} Инверсная нормированная $F_{MMSE}(\psi)$, \subref{fig:4.11b} нормированная $F(\psi)$, $\psi=10^\circ(\psi \approx 0.55), \text{SNR}=30$ дБ}
\end{figure}

Прямое вычисление $F(\psi)$ и поиск его максимума ведет к большим вычислительным затратам. Можно применить условие $F'(\psi) =0$ и получить следующее условие
\begin{equation}
    \label{eq:4.31}
    \begin{aligned}
        \mu(\psi) = &
        \qty(\sum\limits_m f'_m(\psi) \hat p_m) \qty(\sum\limits_m f^2_m(\psi))                              \\
                    & - \qty(\sum\limits_m f_m(\psi)\hat p_m) \qty(\sum\limits_m f_m (\psi) f'_m(\psi)) = 0,
    \end{aligned}
\end{equation}
\begin{equation}
    \label{eq:4.32}
    \begin{aligned}
        f'_m(\psi) = \frac{\sin(0.5N (\psi - \chi_m))}{2\sin^3(0.5(\psi - \chi_m))} \times
        \big[
          & (N-1)\sin(0.5(N+1) (\psi - \chi_m)) - \\
        - & (N+1) \sin(0.5(N-1)(\psi - \chi_m))
            \big]
    \end{aligned}
\end{equation}
Некоторый график $\mu(\psi)$ представлен на рис. \ref{fig:4.11}. Можно заметить, что вокруг заданного $\psi \approx 0.55$ (красная вертикальная линия) есть область где
$\mu(\psi)$ положительна слева и отрицательна справа. Поэтому, если известна грубая оценка угла прихода (что и происходит при иерархическом поиске), мы можем методом дихотомии быстро найти AOA с машинной точностью.
\begin{figure}[ht]
    \centering
    \includegraphics[width=0.75\linewidth]{figs/fig4.11}
    \caption{Нормированная функции $\mu(\psi)$, $\psi=10^{\circ} (\psi \approx 0.55), SNR=30$ дБ}
    \label{fig:4.12}
\end{figure}

\begin{algorithm}
    \caption{Метод дихотомии для оценки угла прихода для улучшенного алгоритма иерархического поиска (hSearchMMSE)}
    \label{lst:4.1}
    \begin{algorithmic}
        \State $\psi_{left} = \psi_{min}$
        \State $\psi_{right} = \psi_{max}$
        \State $\psi_{old} = \psi_{min}$
        \State $\Delta \psi = \infty$
        \While{$\Delta \psi > \epsilon$}
        \State $\hat \psi = 0.5 (\psi_{left} + \psi_{right})$
        \If{$\mu(\psi) < 0$}
        \State $\psi_{right} = \hat\psi$
        \Else
        \State $\psi_{left} = \hat\psi$
        \EndIf
        \State $\Delta \psi = \abs{\hat \psi - \psi_{old}}$
        \EndWhile
        \State \Return $0.5(\psi_{left} + \psi_{right})$
    \end{algorithmic}
\end{algorithm}

Заметим, что лучи вокруг фактического направления АОА вносят основной
вклад в \eqref{eq:4.30}, потому что они имеют более высокие веса. Таким образом, мы можем
рассматривать только лучи, измеренные на этапе процедуры уточнения, и лучший
луч, выбранный на этапе развертки на уровне секторов. Кроме того, для процедуры
поиска желательно, чтобы фактический угол атаки находился в середине
рассматриваемых направлений лучей. Таким образом, мы должны модифицировать
процедуру измерения на этапе уточнения. Некоторые примеры представлены на рис.
\ref{fig:4.12}.
Сплошными серыми линиями показаны ДН лучей, формируемые на первом этапе оценки.
(развертки на уровне секторов). Сплошная красная линия — диаграмма лучшего луча,
выбранного на первой стадии. Штриховые линии — ДН лучей на этапе
уточнения. Наконец, лучи, используемые в \eqref{eq:4.31}, отмечены цветными кривыми.

Всего, мы имеем два случая. В первом случае фактический угол прихода лежит
вблизи лучшего луча и мы проводим дополнительные измерения вокруг этого луча.
Во втором случае фактический угол прихода лежит посередине между лучшим и соседним
лучами. Следовательно, нам необходимо провести дополнительные измерения между ними.
В этом случае весовые векторы  \eqref{eq:4.19} и \eqref{eq:4.33}.
\begin{figure}[ht]
    \centering
    \includegraphics{figs/fig4.12}
    \caption{}
    \label{fig:4.12}
\end{figure}

\begin{equation}
    \label{eq:4.33}
    \chi_q = \eta_v \pm 2\pi \frac{q}{N(M+1)}; ~ q = 1 \dots M.
\end{equation}
Знак зависит от положения лучшего соседнего луча (слева или справа).

Вопрос в том, как мы можем определить, где находится фактический угол прихода до этапа дополнительных измерений.
Предлагается использовать метрику \eqref{eq:4.30} для проверки трех гипотез:
\begin{itemize}
    \item $H_1$ -- угол прихода находится между лучшим лучем и левым соседним лучом
    \item $H_2$ -- угол прихода находится вблизи лучшего луча
    \item $H_3$ -- угол прихода находится между лучшим лучем и правым соседним лучом
\end{itemize}

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.75\linewidth]{figs/fig4.13}
    \caption{Выбор гипотез перед дополнительными измерениями. Черные стрелки принадлежат лучам из первой стадии прозвонки, цветные стрелки показываю центральные направления для различных гипотез}
    \label{fig:4.13}
\end{figure}

Если $\eta_v$ --  пространственная частота наилучшего луча на этапе основных измерений, выбранная нами метрика будет равна
\begin{equation}
    \label{eq:4.34}
    F_{H_n} = \qty[\sum\limits_{m=v-1}^{v+1} f_m (\psi_{H_n}) \hat p_m]^2 \qty[\sum\limits_{m=v-1}^{v+1}f_m^2(\psi_{H_n})]^{-1}
\end{equation}
\begin{equation}
    \label{eq:4.35}
    f_m(\psi_{H_n}) = \frac{\sin^2 (0.5N(\psi_{H_n} - \eta_{m}))}{\sin^2(0.5(\psi_{H_n} - \eta_{m}))}.
\end{equation}
\begin{equation}
    \label{eq:4.36}
    \begin{matrix}
        \psi_{H_1} = \frac{\eta_{v-1} + \eta_v}{2}; &
        \psi_{H_2} = \eta_{v}                       &
        \psi_{H_1} = \frac{\eta_{v+1} + \eta_v}{2}; &
    \end{matrix}
\end{equation}


\begin{enumerate}[label=\textbf{Шаг \arabic*:}]
    \item Этап сканирования. BS производит сканирование лучом, UE
          последовательно использует все лучи из кодовой книги \eqref{eq:4.16} для
          измерения мощности на каждом луче BS. Процедура выполняется для обоих AIP.
    \item \label{enum:hSearchMMSE:2} Выбирается лучшая пара лучей UE-BS и рассматривается выбранный луч UE как лучший сектор
          с пространственной частотой $\eta_v$.
    \item Проверяются гипотезы $H_1, H_2$ и $H_3$ (см. \ref{fig:4.13}) используя метрику \eqref{4:34}.
          Выбирается гипотеза с наибольшим значением метрики. Отметим, что в качестве лучшего луча выбирается первый луч UE ($v=1$), то гипотеза $H_1$ не тестируется.
          Аналогично, не тестируется гипотеза $H_3$ для последнего луча с индексом $v=8$.
    \item \label{enum:hSearchMMSE:4} Этап дополнительных измерений. BS также производит сканирование лучом.
          UE последовательно использует все лучи из кодовой книги \eqref{eq:4.19} для
          измерения мощности на каждом луче BS. Если выбрана гипотеза $H_2$, для формирования кодовой книги используется \eqref{eq:4.20}.
          В остальных случаях используется \eqref{eq:4.33}. Знак <<$-$>> соответствует $H_1$, а <<$+$>> соответствует  $H_3$.
    \item Выполняется алгоритм поиска Алг. \ref{lst:4.1}, используя условие МСКО \eqref{eq:4.31}. В уравнение подставляется мощность лучшего луча, измеренная
          на шаге 2 и мощность лучей из шага 4. Луч BS выбирается таким же, как в лучшей паре на шаге 2.
    \item Рассчитывается угол прихода $\hat \phi$ на основе предполагаемой пространственной частоты. Если лучшая пара лучей UE-BS
          относится к AIP1, то $\hat \phi_{AOA} = \hat \phi$. Если лучшая пара UE-BS относится к AIP2, то $\hat \phi_{AOA} = \hat \phi + \pi$.
\end{enumerate}


Временн\'{а}я структура алгоритма hSearchMMSE представлена на рис. \ref{fig:4.9}. Параметры алгоритма представлены в таб. \ref{tab:4.3}.
\begin{table}
    \centering
    \caption{Параметры алгоритма hSearchMMSE}
    \label{tab:4.3}
    \begin{tabular}{|l|c|}
        \hline
        Параметр                             & SS burst  \\
        \hline
        N / M / AIPs                         & 8 / 4 / 2 \\
        Число просканированных лучей (UE/BS) & 20 / 64   \\
        Суммарное число RS                   & 1280      \\
        Необходимое время (слот 0.125 мс)    & 384 мс    \\
        \hline
    \end{tabular}
\end{table}

\subsection{Алгоритм Auxiliary Beam}
Идея алгоритма доп. луча (Auxiliary Beam) была предложена в \cite{Zhu2016} и \cite{Kim2019}. В отличие от
обычных алгоритмов монопульса (см. раздел \ref{sec:3.2.3}), AuxBeam основан на
мощности и не требует сложного измерения амплитуды. Кроме того, для зондирования
требуется достаточно малое количество лучей, и он совместим с алгоритмами
слежения. Таким образом, это хороший кандидат для модификаций.

Основная идея в следующем. Пусть $\eta_u$ и $\eta_{u+1}$ — обобщенные углы лучей такие, что
$\eta_u<\psi<\eta_{u+1}$ (см. рис. \ref{fig:4.14}), где $\psi$ — обобщенный угол прихода волны.
Пусть $\eta_{u+1}$ ортогонален $\eta_u$, то есть $\eta_{u+1} = \eta_u + 2\delta$, где $\delta = \pi/N$  и
$\tilde \eta_u = 0.5 (\eta_u + \eta_{u+1})$ -- центральное направление.
\begin{figure}[ht]
    \centering
    \includegraphics[width=0.5\linewidth]{figs/fig4.14}
    \caption{Конфигурация лучей для AuxBeam}
    \label{fig:4.14}
\end{figure}

Тогда можно рассмотреть следующую метрику, однозначно зависящую от угла прихода
\begin{equation}
    \label{eq:4.37}
    \zeta(\psi) = \frac{f_u(\psi) - f_{u+1}(\psi)}{f_u(\psi) + f_{u+1}(\psi)} = - \frac{\sin(\psi - \tilde \eta_u) \sin \delta}{1 - \cos(\psi - \tilde \eta_u) \cos \delta}
\end{equation}
\begin{equation}
    \label{eq:4.38}
    f_u(\psi) = \frac{\sin^2 (0.5 N (\psi - \eta_u))}{\sin^2(0.5 (\psi - \eta_u))}
\end{equation}
Зависимость метрики $\zeta(\psi)$  от обобщенного угла прихода представлена на
рис. \ref{fig:4.15}.
\begin{figure}[ht]
    \centering
    \includegraphics[width=0.5\linewidth]{figs/fig4.15}
    \caption{Зависимость метрики $\zeta(\psi)$ для алгоритма AuxBeam}
    \label{fig:4.15}
\end{figure}
В реальной системе метрика $\hat \zeta$ может быть оценена следующим образом
\begin{equation}
    \label{eq:4.39}
    \hat \zeta = \frac{\hat p_u - \hat p_{u+1}}{ \hat p_u + \hat p_{u+1} },
\end{equation}
где $\hat p_u$ -- мощость измеренная на $u$-ом луче. Эта оценка получается смещенной, поскольку $\hat p_u$ включает мощность шума.
Чтобы избежать этого, в знаменателе можно вычесть удвоенную мощность шума, но это может обратить метрику в бесконечность при малом SNR.
И, поскольку, функция $\zeta(\psi)$ достаточно полога на краях интервала $(\eta_u, \eta_{u+1})$, это приводит к высокому
воздействию шума на метрику при вычислении обратной функции.

Кроме того, если угол прихода находится рядом с центральным направлением определенного
луча, мы можем выбрать другой луч так, что условие $\eta_u<\psi < \eta_{u+1}$ не будет выполняться.
Чтобы этого не произошло, предлагается ввести условие на доверительный интервал
$\zeta_{low}<\hat \zeta < \zeta_{up}$, который изображен зеленой штриховкой  на рис.
\ref{fig:4.15}.

Если условие доверительного интервала не выполняется, следует провести дополнительные измерения на смещенных лучах.
Если оно выполняется, можно оценить угол прихода как
\begin{equation}
    \label{eq:4.41}
    \hat \psi = \tilde \eta_u - \arcsin(
    \frac{\hat \zeta \sin\delta}{\sin^2\delta + \hat \zeta^2 \cos^2\delta} -
    \frac{\hat \zeta \sqrt{1- \hat \zeta^2} \sin\delta\ \cos\delta}{\sin^2\delta + \hat \zeta^2 \cos^2\delta}
    )
\end{equation}
\begin{enumerate}[label=\textbf{Шаг \arabic*:}]
    \item Этап сканирования. BS производит сканирование лучом, UE
          последовательно использует все лучи из кодовой книги \eqref{eq:4.16} и \eqref{eq:4.17} для
          измерения мощности на каждом луче BS. Процедура выполняется для обоих AIP.
    \item По результатам измерений, выбирается лучшая пара лучей UE-BS. Для того же луча BS,
          выбирается самый сильный сосед, первого найденного луча. Используя измеренную мощность для выбранных лучей
          вычисляется метрика \eqref{eq:4.39}. Пример выбранных лучей UE представлен на рис. \ref{eq:4.16}.
    \item Если условие $\zeta_{low} < \hat \zeta < \zeta_{up}$, выполняется оценка обобщенного угла прихода $\hat \psi$ используя \eqref{eq:4.41} и пропускается шаг 4.
    \item Пусть $\eta_v$ -- обобщенный угол лучшего луча UE. Проводятся измерения на обобщенных углах
          $\eta_{v+0.5} = \eta_v - \delta$ и
          $\eta_{v-0.5} = \eta_v + \delta$. Дополнительные лучи показаны на рис. \ref{fig:4.16} пунктирными линиями. Далее вычисляется метрика \eqref{eq:4.39}
          и оценивается обобщенный угол прихода $\hat \psi$ (см. \eqref{eq:4.41}).
    \item Рассчитывается угол прихода $\hat \phi$ на основе предполагаемой пространственной частоты. Если лучшая пара лучей UE-BS
          относится к AIP1, то $\hat \phi_{AOA} = \hat \phi$. Если лучшая пара UE-BS относится к AIP2, то $\hat \phi_{AOA} = \hat \phi + \pi$.
\end{enumerate}

\begin{figure}[ht]
    \centering
    \includegraphics{figs/fig4.16}
    \caption{Два варианта выбора лучей UE для алгоритма AuxBeam. Верхний -- в случае выполнения условия на доверительный интервал, нижний -- в обратном случае.}
    \label{<label>}
\end{figure}


\begin{figure}[ht]
    \centering
    \includegraphics[width=\linewidth]{figs/fig4.17}
    \caption{Изображение процедуры иерархического поиска (baseline) во времени для двух антенных решеток. $N=8$, $M=4$, 64 луча BS}
    \label{fig:4.9}
\end{figure}

Временн\'{а}я структура алгоритма AuxBeam представлена на рис. \ref{fig:4.17}. Параметры алгоритма представлены в таб. \ref{tab:4.4}.
\begin{table}
    \centering
    \caption{Параметры алгоритма AuxBeam}
    \label{tab:4.3}
    \begin{tabular}{|l|c|}
        \hline
        Параметр                             & SS burst        \\
        \hline
        N / M / AIPs                         & 8 / 0 или 2 / 2 \\
        Число просканированных лучей (UE/BS) & 16 или 18 / 64  \\
        Суммарное число RS                   & 1024 или 1152   \\
        Необходимое время (слот 0.125 мс)    & 304 или 344 мс  \\
        \hline
    \end{tabular}
\end{table}

\subsection{Сканирование адаптивным методом бисекций}

Еще один многообещающий метод —  Compressed Sensing Algrorithm, идея которого описана \cite{Alkhateeb2014}.
Базовая концепция следующая. Пусть имеется сетка возможных
обощенных углов прихода волны $\psi_q = - \pi\frac{(Q-1)}{Q} + \frac{2\pi}{Q} (q-1)$, где $Q$ -- размер сетки.
Мы можем представить сигнал, измеренный пользователем (UE) для фиксированного
луча BS, как
\begin{equation}
    \label{eq:4.42}
    y = \vec w^H\vec S \vec a + \vec \xi,
\end{equation}
\begin{equation}
    \label{eq:4.43}
    \vec S =
    \begin{bmatrix}
        \vec s(\psi_1) & \vec s(\psi_2) & \dots & \vec s(\psi_q) \\
    \end{bmatrix},
\end{equation}
\begin{equation}
    \label{eq:4.44}
    \vec s =
    \begin{bmatrix}
        1 & \exp{i\psi} & \dots & \exp\{ i(N-1)\psi\} \\
    \end{bmatrix}^T,
\end{equation}
\begin{equation}
    \label{eq:4.45}
    \vec a =
    \begin{bmatrix}
        0 & \dots & 0 & a & 0 & \dots 0 \\
    \end{bmatrix}^T,
\end{equation}

где $\vec w$ -- весовой вектор пользователя,
$\vec s(\psi)$ -- диаграмообразующий вектор,
$N$ -- число элементов в антенной решетке,
$\vec \xi$ -- вектор шума,
$\vec z$ -- вектор комплексной аплитуды размерности $(Q\times 1)$,
где все элементы нулевые, кроме одного, отвечающему фактическому углу
прихода излучения на решетку.
Основная задача алгоритмов этого семейства -- восстановить вектор $\vec a$
используя количество измерений $L \ll Q$.  Если мы рассмотрим некоторую кодовую
книгу $\vec W$ размером $(N \times L)$, чьи столбцы являются весовыми векторами
для луча пользователя, результат сканирования будет
следующим
\begin{equation}
    \label{eq:4.46}
    y = \vec W^H\vec S \vec a + \vec \xi,
\end{equation}

В работе \cite{Alkhateeb2014}, авторы утверждают, что их адаптивный алгоритм более эфективен,
чем обычный алгоритм бисекции. В адаптивном алгоритме процедура зондирования разбита на несколько этапов
и кодовая книга $\vec W$ текущего этапа зависит от предыдущих результатов. Понятно, что если нас не интересует значение $a$, то
вектор $\vec a$ может быть сжат до вектора $\vec z$. Этот вектор кодирует позицию ненулевого жлемента в векторе $\vec a$ (индекс $q$) и
требует только $\log(Q)$ итераций.

На первом шаге считаем, что ненулевой жлемент имеет индекс от $1$ до $Q/2$ ($z_1=0$) или
$Q/2+1$ до $Q$ ($z_1=1$). Для этого нам необходимо сформировать кодовую книгу $\vec W$ размерности $(N \times 2)$, которая удовлетворяет условию
\begin{equation}
    \label{eq:4.47}
    \vec S^H \vec W = \alpha \vec G,
\end{equation}
\begin{equation}
    \label{eq:4.48}
    \vec G =
    \begin{pmatrix}
        1 & \dots & 1 & 0 & \dots & 0 \\
        0 & \dots & 0 & 1 & \dots & 1 \\
    \end{pmatrix}^T,
\end{equation}
где $\vec G$ -- матрица $(Q \times 2)$ и $\alpha$ -- нормировочный множитель.
Физически это означает, что первый весовой вектор должен обеспечивать однородную структуру ДН по
обобщенным углам $\psi_1 \dots \psi_{Q/2}$ и подавлять ДН в направлениях $\psi_{Q/2 + 1}\dots \psi_Q$. Второй весовой вектор должен сделать противоположное.
Приближенное решения для кодовой книги $\vec W$ получается следующим
\begin{equation}
    \label{eq:4.49}
    \vec W = \alpha (\vec S \vec S^H)^{-1} \vec S \vec G
\end{equation}

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.5\linewidth]{figs/fig4.18}
    \caption{ДН для первого шага алгоритма $Q=40,~N=8$}
    \label{fig:4.18}
\end{figure}
Кодовый вектор, при котором будет принята наибольшая мощность будет соответствовать
первому приближению направления на источник. Пусть $z_1 = 0$. Тогда на следующим шаге
мы должны определить $z_2$. Это означает, что ненулевой элемент лежит между индексами $1$ или $Q/4$ ($z_2 =0 | z_1 =0$) или
между ииндексами $Q/4 + 1$ и $Q/2$ ($z_1 = 1 | z_1 = 0$). В этом случае матрица $\vec G$ определяется как
\begin{equation}
    \label{eq:4.48}
    \vec G =
    \begin{pmatrix}
        1 & \dots & 1 & 0 & \dots & 0 & 0  & \dots  & 0 & 0 & \dots & 0 \\
        0 & \dots & 0 & 1 & \dots & 1 & 0  & \dots  & 0 & 0 & \dots & 0 \\
    \end{pmatrix}^T.
\end{equation}
\begin{figure}[ht]
    \centering
    \includegraphics[width=0.5\linewidth]{figs/fig4.19}
    \caption{ДН для второго шага алгоритма, если $z_1=0$, $Q=40,~N=8$}
    \label{fig:4.19}
\end{figure}

Таким образом, ненулевые элементы в матрице $\vec G$ определяются сканированием необходимого индекса луча.
Процедура продолжается до тех пор, пока не будет определен последний элемент $z$. Проблема в том, что 
с выбранной в данной работе аппаратной конфигурации пользователя мы не можем
применить \eqref{eq:4.49}, поскольку у нас не хватает степеней свободы, чтобы
обеспечить равномерное формирование направленности в одной области пространства
и полностью подавить други. Поэтому, мы предлагаем некоторую модификацию этого алгоритма на основе дихотомии, следуя физическим принципам вышеизложенного. 

\begin{enumerate}[label=\textbf{Шаг \arabic*:}]
    \item BS периодически переключает свои лучи, UE использует следующий весовой вектор $\vec w = \mqty*[1 & 0 & \dots & 0]^T$ для каждой AIP. 
    Физически это означает, что отключаются все элементы АР, кроме одного. ДН всей решетки совпадает с ДН элемента и становится квази-всенаправленной. 
    Выбирается та AIP, где результирующая измеренная мощность оказывается больше. 
    \item BS периодически переключает свои лучи. Обозначим $\eta_{left} = - \pi$, $\eta_{right} = + \pi$. 
    На стороне пользователя применяется следующая кодовая книга 
    \begin{equation}
        \vec W = 
        \begin{pmatrix}
        \mqty{ 1 & \exp{i\eta_1}} & \zmat{1}{6}\\
        \mqty{ 1 & \exp{i\eta_2}} & \zmat{1}{6}\\
        \end{pmatrix}
    \end{equation}
    \begin{equation}
        \eta_1 = \frac34 \eta_{left} + \frac14 \eta_{right}; ~ \eta_2 = \frac14 \eta_{left} + \frac34 \eta_{right}
    \end{equation}
    Если первый вектор бимформинга обеспечил наибольшую принятую мощность, то 
    $\eta_{right} = 0.5 (\eta_{left} + \eta_{right})$. 
    В другом случае 
    $\eta_{left} = 0.5 (\eta_{left} + \eta_{right})$.
    \begin{figure}[h!]
        \centering
        \includegraphics[width=0.5\linewidth]{figs/fig4.20}
        \caption{}
        \label{fig:4.20}
    \end{figure}
    \item BS периодически переключает свои лучи. Пользователь использует следующую кодовую книгу
    \begin{equation}
        \vec W = 
        \begin{pmatrix}
        \mqty{ 1 & \exp{i\eta_1} & \exp{i2\eta_1} & \exp{3i\eta_1}} & \zmat{1}{4}\\
        \mqty{ 1 & \exp{i\eta_2} & \exp{i2\eta_2} & \exp{3i\eta_2}} & \zmat{1}{4}\\
        \end{pmatrix}
    \end{equation}
    \begin{equation}
        \eta_1 = \frac34 \eta_{left} + \frac14 \eta_{right}, ~ \eta_2 = \frac14 \eta_{left} + \frac34 \eta_{right}
    \end{equation}
    \begin{figure}[h!]
        \centering
        \includegraphics[width=0.5\linewidth]{figs/fig4.21}
        \caption{}
        \label{fig:4.21}
    \end{figure}
    Если первый вектор бимформинга обеспечил наибольшую принятую мощность, то 
    $\eta_{right} = 0.5 (\eta_{left} + \eta_{right})$. 
    В другом случае 
    $\eta_{left} = 0.5 (\eta_{left} + \eta_{right})$.
    \item BS периодически переключает свои лучи. Пользователь использует следующую кодовую книгу
    \begin{equation}
        \vec W = 
        \begin{pmatrix}
            1 & \exp{i\eta_1} & \exp{i2\eta_1} & \dots & \exp{i(N-1)\eta_1}\\
            1 & \exp{i\eta_2} & \exp{i2\eta_2} & \dots & \exp{i(N-1)\eta_2}
        \end{pmatrix}
    \end{equation}
    \begin{equation}
        \eta_1 = \frac34 \eta_{left} + \frac14 \eta_{right}, ~ \eta_2 = \frac14 \eta_{left} + \frac34 \eta_{right}
    \end{equation}
    \begin{figure}[h!]
        \centering
        \includegraphics[width=0.5\linewidth]{figs/fig4.22}
        \caption{}
        \label{fig:4.22}
    \end{figure}
    Если первый вектор бимформинга обеспечил наибольшую принятую мощность, то 
    $\eta_{right} = 0.5 (\eta_{left} + \eta_{right})$. 
    В другом случае 
    $\eta_{left} = 0.5 (\eta_{left} + \eta_{right})$.
    \item Предыдущий шаг повторяется, пока не достигнется желаемая точность. Отметим, что ширина ДН начиная с этого шага перестает меняться, изменяется тольно направление луча.
    \item Вычисляем угол прихода используя оцененный обобщенный угол $\hat \psi = 0.5 (\eta_{left} + \eta_{right})$. Если на шаге 1 была выбрана первая решетка, то 
    $\hat \phi_{AOA} = \hat \phi$, в противном случае $\hat \phi_{AOA} = \hat \phi + \pi$.
\end{enumerate}

\begin{figure}[h!]
    \centering
    \includegraphics[width=0.5\linewidth]{figs/fig4.23}
    \caption{}
    \label{fig:4.23}
\end{figure}


\section{Многолучевые алгоритмы оценки угла прихода сигнала}
\subsection{Иерархический поиск с минимизацией СКО}

Однолучевая версия алгоритма hSearchMMSE, описаная в разделе \ref{sec:4.4.2},
может быть расширина на многолучевую.  Однако, этот алгоритм есть аппроксимация
метода Фурье (непрерывного сканирования лучом), hSearchMMSE имеет характерные
недостатки.  Во-первых, разрешение ограничено шириной луча, но в контексте нашей
системы это не настолько критично. Второй недостаток более серьезный, он связан
с эффектов утечки мощности через боковые лепестки ДН.  Это означает, что мы
можем ошибочно распознать основной путь распространения, обнаруженный боковым
лепестком, как запасной путь.  Чтобы избежать подобной ошибки, необходимо
установить порог мощности для обнаружения запасного пути. Этот порог должен
учитывать утечку мощности через боковые лепестки и шумовое воздействие.

\begin{equation}
    \label{eq:4.57}
    Th_1^{mn} = A_n \frac{\sin^2(0.5 N (\eta_u - \hat \psi_1))}{\sin^2(0.5 (\eta_u - \hat \psi_1))} + 9 \sigma^2,
\end{equation}
\begin{equation}
    \label{eq:4.58}
    Th_2^{mn} = G A_n \frac{\sin^2(0.5 N (\eta_u - \hat \psi_1))}{\sin^2(0.5 (\eta_u - \hat \psi_1))} + 9 \sigma^2,
\end{equation}
где $n$ -- индекс луча базовой станции, $n$ -- индекс луча пользователя, $A_n$
-- <<мощность>> основного луча, включающая в себя ДН базовой станции, $G$ --
ослабление мощности элемента антенной решетки при приеме тыльной стороной
решетки ($-23$ дБ), $\eta_u$ -- направление луча пользователя в обобщенных
координатах, $\hat \psi_1$ -- оцененный угол прихода основного луча, $\sigma^2$
-- мощность шума, множитель $9$ добавлен исходя из правила $3\sigma$. Идея второго слагаемого в выражениях \eqref{eq:4.57},\eqref{eq:4.48} в том, чтобы 
уменьшить вероятность ложной тревоги из-за шума. Порог $Th_1$ используется для следящей решетки, той на которой был определен основой луч, а порог $Th_2$ для запасной решетки.
Величина $A_n$ может быть оценена, используя уравнение 
\begin{equation}
    A_n = \frac{1}{M+1} \sum\limits_{m=-M/2}^{M/2} \hat p_{mn} 
    \frac{\sin^2(0.5(\hat \psi_1 - \chi_m))}{0.5 N_{rx}(\hat \psi_1 - \chi_m)},
\end{equation}
где $\chi_m$ -- обобщенный угол, найденный на этапе сканирования (см. раздел \eqref{sec:4.4.2}), $\hat p_{mn}$ -- 
измеренная мощность на $m$-ом луче UE во время этапа дополнительных измерений и $n$-ом луче BS. Стоит отметить, что $A_n$ для каждого луча оченивается независимо. 

Пошагово алгоритм выглядит следующим образом. 
\begin{enumerate}[label=\textbf{Шаг \arabic*:}]
    \item BS производит сканирование лучом. UE последовательно использует
    каждый луч из кодовой книги \eqref{eq:4.16} для измерения мощности на каждом луче BS.
    Эта процедура выполняется для AIP1 и AIP2. Мощность измерения на этом этапе сохраняется в
    матрицах $\vec P_1$ и $\vec P_2$ соответственно. Каждый элемент матрицы соответствует
    определенным парам лучей UE и BS.
    \item Выбирается лучшая пара лучей UE-BS. Обозначим обобщенный угол лучшего луча как $\eta_{v1}$ и индекс лучшего луча BS как 
    $q_1$. 
    \item Тестируются гипотезы $H_1$, $H_2$, $H_3$ (см. рис. \ref{fig:4.14}) с помощью \eqref{eq:4.34}. Мощность на соседний лучах пользователя 
    ($u=v-1$, $u=v+1$) измеряется на одинаковых лучах BS с индексом $q_1$. Выбирается гипотеза с наибольшей метрикой \eqref{eq:4.34}.
    \item 
\end{enumerate}



