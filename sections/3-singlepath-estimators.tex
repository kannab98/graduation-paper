
\section{Однолучевые алгоритмы оценки угла прихода сигнала в системе 5G NR}
\label{sec:singlepath}
Поскольку производительность системы mmWave зависит от точности формирования ДН,
основная задача этой работы заключается в разработке точного алгоритма оценки
АОА. Рассматриваемая задача имеет множество существенных ограничений, которые
учитываются в этом исследовании.  Во-первых, разработанный алгоритм должен быть
основан на пилотных сигналах стандарта 5G NR, то есть он должен иметь
фиксированную дискретную временн\'{у}ю структуру.  Во-вторых,
алгоритм должен выполняться на стороне пользователя и БС не может изменять свою
схему прозвонки. В-третьих, при смене центрального направления ДН возникают
скачки фазы, что требует дополнительных калибровок и затрудняет когерентный
прием сигнала, поэтому желательно, чтобы алгоритм был основан только на
измерениях мощности и не зависел от фазы сигнала.

На основе проведенного обзора литературы (см. раздел \ref{sec:review})
были выделены и разработаны несколько подходов, отвечающих вышеперечисленным
требованиям. В качестве базового алгоритма был выбран
иерархический поиск (см.  \ref{sec:hierarchy:search}).  Это простейший метод,
который адаптивно аппроксимирует алгоритм Фурье (см. \ref{sec:Fourier}).
Основной проблемой этого алгоритма будет ошибка квантования.  В данной работе
разработан новый алгоритм, основанный на идее иерархического поиска.  Он
использует улучшенную схему измерения и получает оценку без ошибки квантования
на основе критерия минимума среднеквадратичной ошибки (MMSE).

Второй рассматриваемый алгоритм основан на моноимпульсе (см.
\ref{sec:monopulse}), идея которого была предложена в \cite{Zhu2016, Kim2019},
но только для одной антенной решетки. В данной работе этот алгоритм тестировался
и модифицировался под выбранную аппаратную конфигурацию.  Этот алгоритм также
обеспечивает непрерывный результат.

Третий рассмотренный алгоритм, так называемый \textit{Adaptive Compressed
    Sensing}, который был предложен в \cite{Alkhateeb2014}.  Этот алгоритм
представляет собой схему бинарного поиска со специальной кодовой книгой. Это
одно из самых простых и эффективных решений, среди подобных алгоритмов.  Кроме
того, он основан исключительно на мощностных характеристиках принятого сигнала.
Однако описанное решение и кодовая книга подойдут только для очень больших
антенных решеток со степенями свободы как по фазе, так и амплитуде. Для
выбранной конфигурации, описанное в \cite{Alkhateeb2014} нельзя применить
напрямую, поэтому алгоритм пришлось модифицировать.  Основным преимуществом
этого алгоритма по сравнению с остальными двумя является малое временя зондирования.

Все упомянутые выше алгоритмы были модифицированы для оценки многолучевого AOA.

В этом разделе приведено подробное описание алгоритмов, схем измерений. В
разделе \ref{sec:simulations} представлены результаты моделирования.


\subsection{Структура пилотных сигналов в системах 5G NR}
\label{sec:ssburst}

Стандарт 5G NR включает два типа пилотных сигналов, которые можно использовать для определения угловой координаты источника: SS-burst
и CSI-RS.

\subsubsection{Последовательность блоков сигнала синхронизации}

Чтобы пользователь (UE) мог найти базовую станцию (BS) при входе в систему, со
стороны BS по нисходящей линии связи (Downlink) передается специальный сигнал
синхронизации, состоящий из двух частей: первичного сигнала синхронизации (PSS)
и вторичного сигнала синхронизации (SSS). Между PSS и SSS размещается PHCB --
физический широковещательный канал, несущий основную системную информацию. В NR 
последовательность PSS, SSS, PHCB называется блоком сигнала синхронизации (SS
block) \cite{Dahlman2018}. Структура одного SS блока изображена на рис. \ref{fig:4.1}. 
Пилотные сигналы PSS/SSS занимают полосу в 127 поднесущих с шагом по частоте 125 кГц. 
Каждый SS-блок передается с уникальным весовым вектором $\vec w$, что 
позволяет за один SS блок прозвонить только одну пару лучей UE-BS (см. раздел \ref{sec:Fourier}).  
Последовательность SS-блоков объединяется в SS-burst (см.рис. \ref{fig:4.2}).  
Максимальное количество SS блоков в SS-burst равно 64. 
SS-burst повторяются с периодом, находящимся  в диапазоне от 5 до 160 мс \cite{Dahlman2018}.  
В работе выбрано значение 20 мс.

Поскольку сигнал SS-burst всегда присутствует в системе 5G NR, предпочтительно 
использовать именно его для разработки различных алгоритмов управления ДН. 

Однако SS-burst передается с достаточно большой периодичностью и в случае 
быстроменяющихся каналов его может быть недостаточно, чтобы получать достоверную
информацию о канале (см. раздел \ref{sec:singlepath:rotation:NLOS}). Поэтому в 
системе присутствует ещё один опциональный пилотный сигнал -- CSI-RS.


\begin{figure}[h!]
    \centering
    \includegraphics[width=0.4\linewidth]{figs/fig4.1}
    \caption{Структура блока синхронизации}
    \label{fig:4.1}
\end{figure}
\begin{figure}[h!]
    \centering
    \includegraphics[width=\linewidth]{figs/fig4.2}
    \caption{Последовательность блоков синхронизации (SS-burst)}
    \label{fig:4.2}
\end{figure}


\subsubsection{Пилотный сигнал CSI}
Для более детальной оценки состояния канала используется более гибкий
дополнительный пилотный сигнал Channel State Information Reference Signal.
CSI-RS занимает одну поднесущую в каждом PRB (см. рис. \ref{fig:4.2a}), то есть
максимально 32 поднесущие на всю частотную полосу. 
Он может передаваться периодически
с периодом от 4 до 640 слотов, квазипериодически и
апериодически \cite{Dahlman2018}. 
В работе рассматривается периодическая последовательность с минимальным периодом
в 4 слота.  Если не указано обратного, везде в данной работе считать
длительность слота равной $0.125$ мс

\begin{figure}[h!]
    \centering
    \includegraphics[width=0.5\linewidth]{figs/fig4.2a}
    \caption{}
    \label{fig:4.2a}
\end{figure}

\subsection{Пользовательская система антенных решеток}
\begin{figure}[ht]
    \centering
    \includegraphics[width=0.5\linewidth]{figs/fig4.3}
    \caption{Расположение антенных решеток на мобильном устройстве}
    \label{fig:4.3}
\end{figure}

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.4\linewidth]{figs/fig4.4}
    \caption{В системе присутствует только один АЦП и независимые фазовращатели для каждого элемента АР}
    \label{fig:4.4}
\end{figure}

В данной работе разрабатываются алгоритмы для системы, состоящей из двух линейных эквидистантных антенных решеток, расположенных на противоположных сторонах
устройства (см. \ref{fig:4.3}). В данной конфигурации оборудования, у пользователя нет слепых зон в азимутальной плоскости.

Система содержит только один цифровой порт (АЦП). Таким образом, решетки не могут
использоваться одновременно и возможно только переключение между ними.

Формирование ДН происходит с помощью непрерывных независимых аналоговых фазовращателями, как показано
на \ref{fig:4.4}.  Диаграмма направленности каждого антенного элемента устанавливается в
соответствии с таблицей 7.3-1 стандарта 3GPP TR 38.901. Ширина луча по уровню -3
дБ составляет $65^\circ$, усиление составляет 8 дБи, поляризация предполагается вертикальной.





Также стоит определить что подразумевается под угловой координатой источника
излучения.  Поскольку выбранная конфигурация АР линейна, невозможно одновременно
азимутальный угол и угол места принятого излучения.  Однако линейная решетка
может определить обобщенный угол $\psi$. Можно рассматривать некоторый
эффективный азимутальный угол $\phi_{eff}$ в качестве угловой координаты
источника, который удовлетворяет следующему уравнению
\begin{equation}
    \label{eq:4.1}
    \psi = 2\pi \frac{d}{\lambda} \sin \phi_{eff} = 2\pi \frac{d}{\lambda} \sin\phi \cos{\theta},
\end{equation}
\begin{equation}
    \label{eq:4.2}
    \phi_{eff} = \arcsin(\sin \phi \cos \theta),
\end{equation}
где $\phi$ и $\theta$ -- геометрические углы азимута и элевации источника в ЛКС
пользователя (см. рис. \ref{fig:4.5}).

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.75\linewidth]{figs/fig4.5}
    \caption{Локальная система координат пользователя}
    \label{fig:4.5}
\end{figure}

\subsection{Антенная решетка базовой станции и система прозвонки}

Антенная решетка базовой станции представляет собой эквидистантную плоскую
антенную решетку с 12 строками и 16 столбцами с двумя цифровыми портами.
Формирование диаграммы направленность происходит независимыми непрерывными
аналоговыми фазовращателями. Таким образом, можно одновременно прозвонить два
луча, если это позволяет структура пилотного сигнала.

Диаграмма направленности антенного элемента устанавливается в соответствии с
таблицей 7.3-1 стандарта 3GPP TR 38.901. Ширина луча элемента по уровню $-3$ дБ
составляет $65^\circ$. Усиление составляет 8 дБи, поляризация предполагается вертикальной.

В результате мы имеем 192 пары ортогональных лучей для этой антенной решетки.
Однако мы не сможем прозвонить их все за один SS-burst (см. \ref{sec:ssburst}),
поскольку нам доступно только 64 возможных прозвонки. Для решения этой проблемы
можно учесть две особенности.  Во-первых, пользователи в пространстве перемещаются больше в
горизонтальной плоскости, чем в вертикальной. Поэтому можно увеличить ширину
луча в вертикальной плоскости и уменьшить количество лучей с различными углами
элевации.  Во-вторых, в mmWave системе пользователи обычно располагаются ниже
БС, поэтому лучи соответствующие верхнему подпространству БС могут не
рассматриваться.

Тогда, проблема решается следующим образом:
\begin{itemize}
    \item Верхние 4 ряда антенной решетки БС отключаются (см. \ref{fig:4.6}), обеспечивая более широкую ДН в вертикальной плоскости
    \item Кодовая книга БС выбирается на основе алгоритма Фурье (см.
    \ref{sec:Fourier}). Горизонтальная сетка обобщенных углов $-\pi +
    \pi/16:\pi/8:\pi-\pi/16$.
          Вертикальная сетка обобщенных углов $-3\pi/4:\pi/4:0$.
    \item Представленная кодовая книга покрывает нижнюю половину пространства (см. \ref{fig:4.6}), где, как ожидается, будет находиться пользователь.
\end{itemize}

\begin{figure}[h!]
    \centering
    \includegraphics[width=0.35\linewidth]{figs/fig4.5.png}
    \caption{Серые элементы антенной решетки отключены во время оценки угла прихода на SS-burst}
    \label{fig:4.6}
\end{figure}

\begin{figure}[h!]
    \centering
    \includegraphics[width=0.5\linewidth]{figs/fig4.6}
    \caption{ДН антенной решетки БС в вертикальной плоскости}
    \label{fig:4.7}
\end{figure}


CSI-RS рассматривается как наиболее предпочтительный сигнал для быстро меняющегося канала. 
Но чтобы уменьшить время зондирования, количество
зондируемых лучей БС должно быть значительно уменьшено. Предлагается
использовать 8 ортогональных лучей в горизонтальной плоскости с квази изотропным распределением 
в вертикальной плоскости.
Чтобы реализовать эту схему формирования луча, необходимо отключить все
элементы, кроме первой половины первой строки (см. рис. \ref{fig:4.8}).

\begin{figure}[h!]
    \centering
    \includegraphics[width=0.35\linewidth]{figs/fig4.8.pdf}
    \caption{Серые элементы антенной решетки отключены во время оценки угла прихода на CSI-RS}
    \label{fig:4.8}
\end{figure}

\subsection{Оценка мощности}

Поскольку разрабатываемые алгоритмы должны быть основаны на мощности, ключевым
моментом является способ измерения мощности сигнала. Для каждой пары лучей UE-BS
у нас есть набор пилотных поднесущих, поэтому есть два пути измерения:
\begin{enumerate}
    \item Усреднить мощность по всем пилотным поднесущим.
    \item Использовать Фурье преобразование по всем пилотным поднесущим, перейти от частотной характеристики канала к временной и оценить мощность как максимум импульсной характеристиках канала.
\end{enumerate}

Возьмем для начала однолучевую модель канала. В этом случае сигнал, принятый на $q$-ой пилотной поднесущей примет вид
\begin{equation}
    x_q = a e^{-i2\pi q\Delta f \tau} + \xi_q,
\end{equation}
где $a$ комплексная амплитуда луча, включающая в себя диаграмму направленность
элемента, $\Delta f$ расстояние между пилотными поднесущими в частотной области,
$\tau$ -- задержка распространения, $\xi$ -- комплексны белый гауссовый шум с
мощностью $\sigma^2$.
Для первого варианта, оцененная мощность примет вид
\begin{equation}
    \hat p_1 = \frac{1}{Q} \sum\limits_{q = 0}^{Q - 1} \abs{x_q}^2,
\end{equation}
где $Q$ -- число пилотных поднесущих. После несложных вычислений, можем получить
\begin{equation}
    \mean{\hat p_1} = \abs{a}^2 + \sigma^2.
\end{equation}
\begin{equation}
    D_1 = \mean{p_1^2} - \mean{p_1}^2 = \frac{1}{Q}\qty(2\abs{a}^2 \sigma^2 + \sigma^4),
\end{equation}
где $\mean{\dots}$ -- математическое ожидание, $D$ -- дисперсия оценки мощности.



Во всех алгоритмах нас интересует $\abs{a}^2$ или пропорциональная ей величина.
Относительная систематическая ошибка $\delta_{s1}$ и относительная случайная ошибка $\delta_{r1}$ равны
\begin{equation}
    \delta_{s1} = \frac{\mean{\hat p_1} - \abs{a}^2}{\abs{a}^2} = \frac{\sigma^2}{\abs{a}^2},
\end{equation}
\begin{equation}
    \delta_{r1} = \frac{\sqrt{D_1}}{\abs{a}^2} =
    \frac{1}{\sqrt{Q}} \sqrt{2 \frac{\sigma^2}{\abs{2}} +
        \frac{\sigma^4}{\abs{a}^4}},
\end{equation}
Для второго варианта, оцененная мощность будет вычисляться следующим образом
\begin{equation}
    \hat p^2 = \max_n\qty(\frac{1}{Q} \sum\limits_{q=0}^{Q-1} x_q e^{-2 \pi q n /Q})^2,
\end{equation}
где $n$ -- индекс в оцененной дискретной ИХ канала. 
Если предположить, что выбор максимума всегда осуществляется корректно, можно
получить следующее
\begin{equation}
    \mean{\hat p_2} = \abs{a}^2 F + \frac{1}{Q}\sigma^2.
\end{equation}
\begin{equation}
    D_2 = \mean{\hat p_2^2} - \mean{\hat p_2}^2 = \frac{2\abs{a}^2 F \sigma^2}{Q},
\end{equation}
\begin{equation}
    F = \max_n \frac{\sin^2[\pi Q (\Delta f \tau - n/Q)]}{Q^2 \sin^2[\pi(\Delta f \tau - n/Q)]},
\end{equation}
\begin{equation}
    \frac{4}{\pi^2} \leq \frac{1}{Q^2 \sin^2[\frac{\pi}{2Q}]} \leq F \leq 1,
\end{equation}


Относительную систематическую ошибку $\delta_{s2}$ и относительную случайную ошибку $\delta_{r2}$ следует
определять как
\begin{equation}
    \delta_{s2} = \frac{\mean{\hat p_2} - F \abs{a}^2}{F \abs{a}^2} = \frac{1}{Q} \frac{\sigma^2}{F\abs{a}^2},
\end{equation}
\begin{equation}
    \delta_{r2} = \frac{\sqrt{D_1}}{F\abs{a}^2} = \frac{1}{\sqrt Q} \sqrt{\frac{2\sigma^2}{F\abs{a}^2}}.
\end{equation}
Второй подход лучше применять к оценке мощности для моноимпульса (см. \ref{sec:monopulse}) и случаев с
низкими ОСШ. Также, если задачей является оценка направления на основной луч в
многолучевом канале, второй подход уменьшает помехи, вызванными остальными лучами.
Однако в случае многолучевой оценки угла прихода второй подход приводит к
большой сложности, из-за необходимости рассматривать трехмерную задачу для
каждого возможного пути распространения.

Таким образом, в работе применяется следующая схема оценки мощности
\begin{enumerate}
    \item Для оценки угловой координаты в многолучевом канале, используется
    первый подход (усреднение принятой мощности по пилотным поднесущим). 
    \item Для оценки угловой координаты в однолучевом канале, применяется второй
    подход (Time Of Arrival selection). 
\end{enumerate}



\subsection[Иерархический поиск]{Иерархический поиск -- \baseline{}}
\label{sec:hSearch}\label{sec:hierarchy:search}
Эффективность иерархического поиска, в результатах симуляции в разделе
\ref{sec:simulations} он назван \textit{baseline}, рассматривается как нижняя
граница разработанных алгоритмов.  Можно было бы в качестве базового алгоритма
рассматривать метод Фурье (см. \ref{sec:Fourier}) и необходимый для него полный
перебор по всем парам лучей (UE-BS), примененный к меняющемуся во времени
каналу.  Однако он дает слишком высокую ошибку дискретизации и сравнивать и
редко применяется в реальных системах.

Алгоритм состоит из двух этапов: полного перебора всех пар лучей UE-BS и
процедуры дополнительных измерений.
На первом этапе пользователь использует ортогональную кодовую книгу, покрывающую
диапазон углов от $-\pi$ до $\pi$:
\begin{equation}
    \label{eq:4.16}
    \vec w_u =
    \begin{bmatrix}
        1 & \exp {i \eta_u} & \dots & \exp{i(N-1)\eta_u}
    \end{bmatrix}^T,
\end{equation}
\begin{equation}
    \label{eq:4.17}
    \eta_u = -\pi \frac{N-1}{N} + 2\pi \frac{u-1}{N},
\end{equation}
где $N$ -- число элементов антенной решетки, $u$ -- индекс весового вектора, лежащий в интервале $\qty[1 \dots N]$, $\eta_u$ -- обобщенный угол, соответствующий углу прихода сигнала следующим образом
\begin{equation}
    \eta_u = 2\pi \frac{d}{\lambda_w}\sin\phi_u,
\end{equation}
где $d$ -- расстояние между элементами решетки, $\lambda_w$ -- длина волны. ДН,
получаемые с помощью данной кодовой книги показаны на рис. \ref{fig:4.9}
сплошными линиями.
\begin{figure}[ht]
    \centering
    \includegraphics[width=0.5\linewidth]{figs/fig4.8.png}
    \caption{Различные ДН, формируемые кодовой книгой на стороне пользователя. $\psi$ -- обобщенный угол, $N=8$, $M=4$}
    \label{fig:4.9}
\end{figure}

Пусть $v$ -- индекс наилучшего весового вектора $\vec w_u^{(v)}$, который
обеспечивает наибольшую принятую мощность на антенной решетке.  Соответствующая
ДН показана на рис. \ref{fig:4.9} толстой сплошной линией. Пусть $p_v$ --
мощность, измеренная для вектора $\vec w_u^{(v)}$. На этапе дополнительных измерений
пользователь тестирует $M$ дополнительных весовых векторов, чтобы уменьшить
ошибку дискретизации.
\begin{equation}
    \label{eq:4.19}
    \vec w_q =
    \begin{bmatrix}
        1 & \exp {i \chi_q} & \dots & \exp{i(N-1)\chi_q}
    \end{bmatrix}^T,
\end{equation}
\begin{equation}
    \label{eq:4.20}
    \chi_q = \eta_v + 2\pi \frac{q}{N(M+1)},
\end{equation}
где $q=-0.5M,\dots,-1,+1,\dots,+0.5M$. Сформированные дополнительные ДН показаны
на рис. \ref{fig:4.9} пунктирными линиями.  Обозначим $p_0= p_v$ и $\chi_0 =
\eta_v$. Отметим, что для процедуры уточнения не нужно проводить измерения
$\chi_0$, поскольку оно уже было сделано на предыдущем этапе.  Наконец, путь
распространения с обобщенным углом $\hat \psi$ оценивается как один из $\chi_q
\in \qty{\chi_{-0.5 M}, \dots, \chi_0, \dots, \chi_{+0.5M}}$, обеспечивающий
наибольшую измеренную мощность $p_q$. Угол прихода соответствующего луча
оценивается как
\begin{equation}
    \label{eq:4.21}
    \hat \phi = \arcsin{\frac{\psi \lambda_w}{2\pi d}}.
\end{equation}

Процедура измерения алгоритма представлена на рис. \ref{fig:4.10} и происходит следующим образом:

\begin{enumerate}[label=\textbf{Шаг \arabic*:}]
    \item Этап сканирования по грубой сетке углов (Sector Level Sweep Stage). 
          BS периодически переключает свои лучи. 
          UE последовательно использует каждый луч из кодовой книги \eqref{eq:4.16} 
          и измеряет мощность на каждом луче BS.
    \item Выбирается пара лучей UE-BS с наибольшей измеренной мощностью.
          Обозначим направление лучшего луча пользователя обобщенным углом $\eta_v$.
    \item Процедура уточнения (дополнительных измерений). BS периодически переключает лучи. UE
          Пользователь последовательно использует лучи из кодовой книги \eqref{eq:4.19} 
          и измеряет мощность на каждой паре лучей UE-BS.
    \item Выбирается лучшая пара лучей UE-BS среди всех измеренных на шаге 3 и шаге 1. 
    Пусть выбранный луч UE имеет пространственную частоту $\hat \psi$.
    \item Если пара лучей UE-BS соответствовала AIP1, то $\hat \phi_{AOA} = \hat \phi$, где 
    $\hat \phi$ вычисляется из \eqref{eq:4.21}.
    Если выбранная пара лучей соответствовала AIP2, то $\hat \phi_{AOA} = \hat \phi + \pi$. 
\end{enumerate}

\begin{figure}[ht]
    \centering
    \includegraphics[width=\linewidth]{figs/fig4.9}
    \caption{Изображение процедуры иерархического поиска (\textit{baseline}) во времени для двух антенных решеток. $N=8$, $M=4$, 64 луча BS}
    \label{fig:4.10}
\end{figure}

Параметры алгоритма иерархического поиска представлены в таблице \ref{tab:4.2}, а его временн\'{а}я
структура на рис. \ref{fig:4.10}.
Предполагается, что один SS-burst состоит из 64 RS и занимает 32 последовательных слота с периодом 20 мс.
Для CSI-RS считаем, что период следования равен 4 слотам (0.5 мс) и могут быть
прозвонены два луча на двух разных цифровых портах.

\begin{table}
    \centering
    \caption{Параметры алгоритма иерархического поиска}
    \label{tab:4.2}
    \begin{tabular}{lcc}
        \toprule
        \midrule
        Структура RS                         & SS-burst  & CSI-RS    \\
        N / M / AIPs                         & 8 / 4 / 2 & 8 / 4 / 2 \\
        Число просканированных лучей (UE/BS) & 20 / 64   & 20/8      \\
        Суммарное число RS                   & 1280      & 160       \\
        Необходимое время                    & 384 мс    & 40 мс     \\
        \bottomrule
    \end{tabular}
\end{table}



\subsection[Иерархический поиск с минимизацией СКО]{Иерархический поиск с минимизацией СКО -- \hSearchMMSE{}}
\label{sec:hSearchMMSE:singlepath}
В теории оценивания AOA доказано, что наилучшее решение дает максимально правдоподобная оценка (Maximum Likelihood Estimator).
Рассматривая случай однолучевого канала, можно представить уравнение \eqref{eq:3.10} в виде
\begin{equation}
    d(\phi) = \sum\limits_q \vec y^H(q) \vec y(q) - \sum\limits_q\abs{\vec y^H \vec s(\phi)}^2 \to \min_\phi,
\end{equation}
\begin{equation}
    \label{eq:4.23}
    \sum\limits_q \abs{\vec y^H(q) \vec s(\phi)}^2 = \hat p(\phi) \to \max_\phi,
\end{equation}
где $\vec y$ -- вектор принятого антенной решеткой сигнала, $\vec s(\phi)$ --
фазирующий вектор. Выражение \eqref{eq:4.23} имеет смысл мощности,
принимаемой с  вектором $\vec s(\phi)$, обеспечивающим максимум ДН в направлении
$\phi$. Максимизация этого значения есть не что иное, как непрерывное
сканирование лучом и получение пространственного распределения мощности.

На практике, мы не можем применить этот оптимальный алгоритм по нескольким
причинам. Во-первых, мы  можем оценить только дискретный спектр мощности.
Разумеется, можно применить некоторые методы интерполяции, но это будет только
приближение.  Во-вторых, у нас есть сильные ограничения по времени, особенно в
случае динамического канала.  Таким образом, метод иерархического поиска,
который адаптивно измеряет дискретный спектр мощности, представляется наиболее
подходящей аппроксимацией оптимального МП-оценки.

Однако приближение спектра мощности с помощью иерархического
поиска, каким он рассматривался в предыдущем разделе \eqref{sec:hSearch}, не
является удачной аппроксимацией.  Прежде всего потому что это приближение с
ошибкой дискретизации. К тому же, если искомая угловая координата источника
лежит на стыке  двух антенных решеток $\hat \phi \approx \pm \pi/2$ или же просто
при низком ОСШ,  можно ошибиться с выбором антенной решетки и эта ошибка не
будет исправлена в дальнейшем. С учетом этим недостатков, был разработан
улучшенный алгоритм иерархического поиска.

На первый взгляд, проблема дискретизации может быть решена с помощью
МП-оценки, адаптированного к последовательному измерению отклика мощности
луча. Однако полученная в этом случае функция правдоподобия сложна для анализа
(здесь предполагается, что амплитуда принимаемого сигнала имеет распределение
Райса).

\begin{equation}
    F_{ML}(\psi, a) = \prod\limits_m \frac{1}{\sigma^2}
    \exp{-\frac{\hat p_m + a f_m(\psi)}{\sigma^2}
        I_0\qty(\frac{2\sqrt{\hat p_m a f_m(\psi)}}{\sigma^2})} \to \max_{\psi, a},
\end{equation}
где $\hat p_m$ -- измеренная мощность на $m$-ом луче, $\sigma^2$ -- мощность
шума, $a$ -- <<мощность>> некоторого пути распространения, $I_0(x)$ --
модифицированная функция Бесселя, $f_m(\psi)$ -- усиление АР для $m$-го луча в
направлении обобщенного угла $\chi_m$, $\psi = 2\pi \frac{d}{\lambda_w}\sin
    \phi$ -- обобщенный угол, а $\phi$ -- угол прихода.
\begin{equation}
    f_m(\psi) = \frac{\sin^2 (0.5N(\psi - \chi_m))}{\sin^2(0.5(\psi - \chi_m))}.
\end{equation}
Поскольку мы пытаемся найти простое решение, мы предлагаем взять в основу
критерий минимума СКО, вместо МП-оценки.
\begin{equation}
    \label{eq:26}
    F_{MMSE}(\psi, a) = \sum\limits_m \qty(\hat p_m - a f_m(\psi))^2 \to \min_{\psi,a}
\end{equation}
В первую очередь, необходимо исключить параметр $a$ из уравнения \eqref{eq:26}.
\begin{equation}
    \pdv{a} F_{MMSE}(\psi, a) = \sum\limits_m 2f_m(\psi) (\hat p_m - a f_m(\psi)) = 0
\end{equation}
\begin{equation}
    a(\psi) = \qty[\sum\limits_m f_m(\psi) \hat p_m][\sum\limits_m f_m^2(\psi)]^{-1}.
\end{equation}
Тогда, окончательный результат
\begin{equation}
    F_{MMSE}(\psi)=\underbrace{\sum\limits_m \hat p_m^2}_{\const} - \qty[\sum\limits_m f_m(\psi) \hat p_m]^2 \qty[\sum \limits_m f_m^2 (\psi)]^{-1} \to \max_{\psi}
\end{equation}
\begin{equation}
    \label{eq:4.30}
    F(\psi)=\qty[\sum\limits_m f_m(\psi) \hat p_m]^2 \qty[\sum \limits_m f_m^2 (\psi)]^{-1} \to \max_{\psi}
\end{equation}
На рис. \ref{fig:4.100} представлен вид функции \eqref{eq:4.30} во время процедуры уточнения для точной оценки угла прихода.

\begin{figure}[h!]
    \begin{subfigure}{0.49\linewidth}
        \centering
        \includegraphics[width=\linewidth]{figs/fig4.10a}
        \caption{}
        \label{fig:4.10a}
    \end{subfigure}
    \begin{subfigure}{0.49\linewidth}
        \centering
        \includegraphics[width=\linewidth]{figs/fig4.10b}
        \caption{}
        \label{fig:4.10b}
    \end{subfigure}
    \caption{ (\subref{fig:4.10a}) Инверсная нормированная $F_{MMSE}(\psi)$,
    (\subref{fig:4.10b}) нормированная $F(\psi)$, $\psi=10^\circ(\psi \approx
    0.55), \text{SNR}=30$ дБ}
    \label{fig:4.100}
\end{figure}

Прямое вычисление $F(\psi)$ и поиск его максимума ведет к большим вычислительным затратам. Можно применить условие $F'(\psi) =0$ и получить следующее условие
\begin{equation}
    \label{eq:4.31}
    \begin{aligned}
        \mu(\psi) = &
        \qty(\sum\limits_m f'_m(\psi) \hat p_m) \qty(\sum\limits_m f^2_m(\psi))                              \\
                    & - \qty(\sum\limits_m f_m(\psi)\hat p_m) \qty(\sum\limits_m f_m (\psi) f'_m(\psi)) = 0,
    \end{aligned}
\end{equation}
\begin{equation}
    \label{eq:4.32}
    \begin{aligned}
        f'_m(\psi) = \frac{\sin(0.5N (\psi - \chi_m))}{2\sin^3(0.5(\psi - \chi_m))} \times
        \big[
          & (N-1)\sin(0.5(N+1) (\psi - \chi_m)) - \\
        - & (N+1) \sin(0.5(N-1)(\psi - \chi_m))
            \big]
    \end{aligned}
\end{equation}
Типичный график $\mu(\psi)$ представлен на рис. \ref{fig:4.12}. Можно заметить, что вокруг заданного $\psi \approx 0.55$ (красная вертикальная линия) есть область где
$\mu(\psi)$ положительна слева и отрицательна справа. Поэтому, если известна грубая оценка угла прихода,
что и происходит на первом этапе алгоритма,
можно методом дихотомии быстро найти AOA с машинной точностью.
\begin{figure}[h!]
    \centering
    \includegraphics[width=0.5\linewidth]{figs/fig4.11}
    \caption{Нормированная функции $\mu(\psi)$, $\psi=10^{\circ} (\psi \approx 0.55), SNR=30$ дБ}
    \label{fig:4.12}
\end{figure}

\begin{algorithm}
    \caption{Метод дихотомии для оценки угла прихода для улучшенного алгоритма иерархического поиска (hSearchMMSE)}
    \label{lst:4.1}
    \begin{algorithmic}
        \State $\psi_{left} = \psi_{min}$
        \State $\psi_{right} = \psi_{max}$
        \State $\psi_{old} = \psi_{min}$
        \State $\Delta \psi = \infty$
        \While{$\Delta \psi > \epsilon$}
        \State $\hat \psi = 0.5 (\psi_{left} + \psi_{right})$
        \If{$\mu(\psi) < 0$}
        \State $\psi_{right} = \hat\psi$
        \Else
        \State $\psi_{left} = \hat\psi$
        \EndIf
        \State $\Delta \psi = \abs{\hat \psi - \psi_{old}}$
        \EndWhile
        \State \Return $0.5(\psi_{left} + \psi_{right})$
    \end{algorithmic}
\end{algorithm}

Заметим, что лучи вокруг фактического направления АОА вносят основной вклад в
\eqref{eq:4.30}, потому что они имеют более высокие веса. Таким образом, мы
можем рассматривать только лучи, измеренные на этапе процедуры уточнения, и
лучший луч, выбранный на этапе перебора по грубой сетке (Sector Level Sweep). Кроме того, для
процедуры поиска желательно, чтобы фактический угол прихода находился в середине
рассматриваемых направлений лучей. Таким образом, мы должны модифицировать
процедуру измерения на этапе дополнительных измерений. Примеры
представлены на рис.  \ref{fig:4.120}.
Сплошными серыми линиями показаны ДН лучей, формируемые на первом этапе оценки
(SLS). Сплошная красная линия -- ДН лучшего луча,
выбранного на первой стадии. Штриховые линии — ДН лучей на этапе
уточнения. Наконец, лучи, используемые в \eqref{eq:4.31}, отмечены цветными кривыми.

Всего, мы имеем два случая. В первом случае фактический угол прихода лежит
вблизи лучшего луча и мы проводим дополнительные измерения вокруг этого луча.
Во втором случае фактический угол прихода лежит посередине между лучшим и соседним
лучами. Следовательно, нам необходимо провести дополнительные измерения между ними.
В этом случае весовые векторы  формируются с помощью выражений \eqref{eq:4.19} и \eqref{eq:4.33}.
Знак в \eqref{eq:4.30} зависит от положения лучшего соседнего луча (слева или справа).
\begin{figure}[h!]
    \centering
    \includegraphics{figs/fig4.12}
    \caption{}
    \label{fig:4.120}
\end{figure}

\begin{equation}
    \label{eq:4.33}
    \chi_q = \eta_v \pm 2\pi \frac{q}{N(M+1)}; ~ q = 1 \dots M.
\end{equation}


Вопрос в том, как мы можем определить, где находится фактический угол прихода до этапа дополнительных измерений.
Предлагается использовать метрику \eqref{eq:4.30} для проверки трех гипотез:
\begin{itemize}
    \item $H_1$ -- угол прихода находится между лучшим лучом и левым соседним лучом
    \item $H_2$ -- угол прихода находится вблизи лучшего луча
    \item $H_3$ -- угол прихода находится между лучшим лучом и правым соседним лучом
\end{itemize}

\begin{figure}[h!]
    \centering
    \includegraphics[width=0.75\linewidth]{figs/fig4.13}
    \caption{Выбор гипотез перед дополнительными измерениями. Черные стрелки принадлежат лучам из первой стадии прозвонки, цветные стрелки показывают центральные направления для различных гипотез}
    \label{fig:4.13}
\end{figure}

Если $\eta_v$ --  пространственная частота наилучшего луча на этапе основных измерений, выбранная нами метрика будет равна
\begin{equation}
    \label{eq:4.34}
    F_{H_n} = \qty[\sum\limits_{m=v-1}^{v+1} f_m (\psi_{H_n}) \hat p_m]^2 \qty[\sum\limits_{m=v-1}^{v+1}f_m^2(\psi_{H_n})]^{-1}
\end{equation}
\begin{equation}
    \label{eq:4.35}
    f_m(\psi_{H_n}) = \frac{\sin^2 (0.5N(\psi_{H_n} - \eta_{m}))}{\sin^2(0.5(\psi_{H_n} - \eta_{m}))}.
\end{equation}
\begin{equation}
    \label{eq:4.36}
    \begin{matrix}
        \psi_{H_1} = \frac{\eta_{v-1} + \eta_v}{2}; &
        \psi_{H_2} = \eta_{v}                       &
        \psi_{H_1} = \frac{\eta_{v+1} + \eta_v}{2}; &
    \end{matrix}
\end{equation}


Тогда структурная схема алгоритма будет следующей
\begin{enumerate}[label=\textbf{Шаг \arabic*:}]
    \item Этап полного перебора по грубой сетке (SLS). BS производит сканирование лучом, UE
          последовательно использует все лучи из своей кодовой книги \eqref{eq:4.16} для
          измерения мощности на каждом луче BS. Процедура выполняется для обоих АР.
    \item Выбирается лучшая пара лучей UE-BS и рассматривается выбранный луч UE
          как лучший сектор с пространственной частотой $\eta_v$.
    \item Проверяются гипотезы $H_1, H_2$ и $H_3$ (см. \ref{fig:4.13}) используя метрику \eqref{eq:4.34}.
          Выбирается гипотеза с наибольшим значением метрики. Отметим, что если в
          качестве лучшего луча выбирается первый луч UE ($v=1$), то гипотеза
          $H_1$ не тестируется.
          Аналогично, не тестируется гипотеза $H_3$ для последнего луча с
          индексом $v=8$.  \item  Этап дополнительных измерений. BS также
          производит сканирование лучом.  UE последовательно использует все лучи
          из кодовой книги \eqref{eq:4.19} для измерения мощности на каждом луче
          BS. Если выбрана гипотеза $H_2$, для формирования кодовой книги
          используется \eqref{eq:4.20}.  В остальных случаях используется
          \eqref{eq:4.33}. Знак <<$-$>> соответствует $H_1$, а <<$+$>>
          соответствует  $H_3$.
    \item Выполняется алгоритм поиска Алг. \ref{lst:4.1}, используя условие МСКО
          \eqref{eq:4.31}. В уравнение подставляется мощность лучшего луча, измеренная
          на шаге 2 и мощность лучей из шага 4. Луч BS выбирается таким же, как в
          лучшей паре на шаге 2.
    \item Рассчитывается угол прихода $\hat \phi$ на основе предполагаемой
          пространственной частоты. Если лучшая пара лучей UE-BS относится к АР\#1, то
          $\hat \phi_{AOA} = \hat \phi$. Если лучшая пара UE-BS относится к AР\#2, то
          $\hat \phi_{AOA} = \hat \phi + \pi$.
\end{enumerate}


Временн\'{а}я структура алгоритма иерархического поиска с минимизацией
среднеквадратичной ошибки (\textit{hSearchMMSE}) совпадает с \baseline{} и представлена на рис. \ref{fig:4.9}.
Параметры алгоритма представлены в табл. \ref{tab:4.3}.
\begin{table}
    \centering
    \caption{Параметры алгоритма hSearchMMSE}
    \label{tab:4.3}
    \begin{tabular}{lcc}
        \toprule
        \midrule
        Структура RS                                  & SS-burst  & CSI-RS    \\
        N / M / AIPs                                  & 8 / 4 / 2 & 8 / 2 / 2 \\
        Число просканированных \newline лучей (UE/BS) & 20 / 64   & 18 / 8    \\
        Суммарное число RS                            & 1280      & 144       \\
        Необходимое время (слот 0.125 мс)             & 384 мс    & 36 мс     \\
        \bottomrule
    \end{tabular}
\end{table}

\subsection[Модифицированный алгоритм моноимпульса]{Модифицированный алгоритм моноимпульса -- \AuxBeam{}}
\label{sec:AuxBeam:singlepath}
Идея алгоритма основанного на моноимпульсе, также известного как \textit{Auxiliary Beam}, была
предложена в \cite{Zhu2016} и \cite{Kim2019}. В отличие от обычных алгоритмов
моноимпульса (см. раздел \ref{sec:monopulse}), \AuxBeam{} основан на мощности и не
требует сложного измерения комплексной амплитуды. Кроме того, для зондирования требуется
достаточно малое количество лучей, и он совместим с алгоритмами слежения.

Основная идея в следующем. Пусть $\eta_u$ и $\eta_{u+1}$ -- обобщенные углы
лучей такие, что $\eta_u<\psi<\eta_{u+1}$ (см. рис. \ref{fig:4.14}), где $\psi$
-- обобщенный угол прихода волны.  Пусть $\eta_{u+1}$ ортогонален $\eta_u$, то
есть $\eta_{u+1} = \eta_u + 2\delta$, где $\delta = \pi/N$  и $\tilde \eta_u =
    0.5 (\eta_u + \eta_{u+1})$ -- центральное направление.
\begin{figure}[h!]
    \centering
    \includegraphics[width=0.5\linewidth]{figs/fig4.14}
    \caption{Конфигурация лучей для \AuxBeam{}}
    \label{fig:4.14}
\end{figure}
Тогда можно рассмотреть следующую метрику, однозначно зависящую от угла прихода
\begin{equation}
    \label{eq:4.37}
    \zeta(\psi) = \frac{f_u(\psi) - f_{u+1}(\psi)}{f_u(\psi) + f_{u+1}(\psi)} = - \frac{\sin(\psi - \tilde \eta_u) \sin \delta}{1 - \cos(\psi - \tilde \eta_u) \cos \delta}
\end{equation}
\begin{equation}
    \label{eq:4.38}
    f_u(\psi) = \frac{\sin^2 (0.5 N (\psi - \eta_u))}{\sin^2(0.5 (\psi - \eta_u))}
\end{equation}
Зависимость метрики $\zeta(\psi)$  от обобщенного угла прихода представлена на
рис. \ref{fig:4.15}.
\begin{figure}[h!]
    \centering
    \includegraphics[width=0.5\linewidth]{figs/fig4.15}
    \caption{Зависимость метрики $\zeta(\psi)$ для алгоритма AuxBeam}
    \label{fig:4.15}
\end{figure}
В реальной системе метрика $\hat \zeta$ может быть оценена следующим образом
\begin{equation}
    \label{eq:4.39}
    \hat \zeta = \frac{\hat p_u - \hat p_{u+1}}{ \hat p_u + \hat p_{u+1} },
\end{equation}
где $\hat p_u$ -- мощность измеренная на $u$-ом луче. Эта оценка получается смещенной, поскольку $\hat p_u$ включает мощность шума.
Чтобы избежать этого, в знаменателе можно вычесть удвоенную мощность шума, но это может обратить метрику в бесконечность при малом SNR.
И, поскольку, функция $\zeta(\psi)$ достаточно полога на краях интервала $(\eta_u, \eta_{u+1})$, это приводит к высокому
воздействию шума на метрику при вычислении обратной функции.

Кроме того, если угол прихода находится рядом с центральным направлением определенного
луча, мы можем выбрать другой луч так, что условие $\eta_u<\psi < \eta_{u+1}$ не будет выполняться.
Чтобы этого не произошло, предлагается ввести условие на доверительный интервал
$\zeta_{low}<\hat \zeta < \zeta_{up}$, который изображен зеленой штриховкой  на рис.
\ref{fig:4.15}.

Если условие доверительного интервала не выполняется, следует провести дополнительные измерения на смещенных лучах.
Если оно выполняется, можно оценить угол прихода как
\begin{equation}
    \label{eq:4.41}
    \hat \psi = \tilde \eta_u - \arcsin(
    \frac{\hat \zeta \sin\delta}{\sin^2\delta + \hat \zeta^2 \cos^2\delta} -
    \frac{\hat \zeta \sqrt{1- \hat \zeta^2} \sin\delta\ \cos\delta}{\sin^2\delta + \hat \zeta^2 \cos^2\delta}
    )
\end{equation}
\begin{enumerate}[label=\textbf{Шаг \arabic*:}]
    \item Этап SLS. BS производит сканирование лучом, UE
          последовательно использует все лучи из кодовой книги \eqref{eq:4.16} для
          измерения мощности на каждом луче BS. Процедура выполняется для всех АР.
    \item По результатам измерений, выбирается лучшая пара лучей UE-BS. Для того же луча BS,
          выбирается самый сильный сосед, первого найденного луча. Используя измеренную мощность для выбранных лучей
          вычисляется метрика \eqref{eq:4.39}. Пример выбранных лучей UE представлен на рис. \ref{fig:4.17}.
    \item Если условие $\zeta_{low} < \hat \zeta < \zeta_{up}$, выполняется оценка обобщенного угла прихода $\hat \psi$ используя \eqref{eq:4.41} и пропускается шаг 4.
    \item Пусть $\eta_v$ -- обобщенный угол лучшего луча UE. Проводятся измерения на обобщенных углах
          $\eta_{v+0.5} = \eta_v - \delta$ и
          $\eta_{v-0.5} = \eta_v + \delta$. Дополнительные лучи показаны на рис. \ref{fig:4.17} пунктирными линиями. Далее вычисляется метрика \eqref{eq:4.39}
          и оценивается обобщенный угол прихода $\hat \psi$ (см. \eqref{eq:4.41}).
    \item Рассчитывается угол прихода $\hat \phi$ на основе предполагаемой пространственной частоты. Если лучшая пара лучей UE-BS
          относится к АР1, то $\hat \phi_{AOA} = \hat \phi$. Если лучшая пара UE-BS относится к АР2, то $\hat \phi_{AOA} = \hat \phi + \pi$.
\end{enumerate}

\begin{figure}[h!]
    \centering
    \includegraphics{figs/fig4.16}
    \caption{Два варианта выбора лучей UE для алгоритма AuxBeam. Верхний -- в случае выполнения условия на доверительный интервал, нижний -- в обратном случае.}
    \label{fig:4.17}
\end{figure}


\begin{figure}[h!]
    \centering
    \includegraphics[width=\linewidth]{figs/fig4.17}
    \caption{Изображение \AuxBeam{} во времени для двух антенных решеток. $N=8$, $M=4$, 64 луча BS}
    \label{fig:timeline:auxbeam}
\end{figure}

Временн\'{а}я структура алгоритма AuxBeam представлена на рис. \ref{fig:timeline:auxbeam}. Параметры алгоритма представлены в табл. \ref{tab:parameters:auxbeam}.
\begin{table}
    \centering
    \caption{Параметры алгоритма AuxBeam}
    \label{tab:parameters:auxbeam}
    \begin{tabular}{lcc}
        \toprule
        \midrule
        Структура RS                         & SS burst        & CSI-RS        \\
        N / M / AIPs                         & 8 / 0 или 2 / 2 & 8 / 0 или 2/2 \\
        Число просканированных лучей (UE/BS) & 16 или 18 / 64  & 16 или 18 / 8 \\
        Суммарное число RS                   & 1024 или 1152   & 128 или 144   \\
        Необходимое время (слот 0.125 мс)    & 304 или 344 мс  & 32 или 36 мс  \\
        \hline
    \end{tabular}
\end{table}

\subsection[Сканирование адаптивным методом бисекций]{Сканирование адаптивным методом бисекций -- \ACS{}}
\label{sec:ACS:singlepath}

Еще один многообещающий метод —  Adaptive Compressed Sensing, идея которого описана \cite{Alkhateeb2014}.
Базовая концепция следующая. Пусть имеется сетка возможных
обобщенных углов прихода волны $\psi_q = - \pi\frac{(Q-1)}{Q} + \frac{2\pi}{Q} (q-1)$, где $Q$ -- размер сетки.
Мы можем представить сигнал, измеренный пользователем (UE) для фиксированного
луча BS, как
\begin{equation}
    \label{eq:4.42}
    y = \vec w^H\vec S \vec a + \vec \xi,
\end{equation}
\begin{equation}
    \label{eq:4.43}
    \vec S =
    \begin{bmatrix}
        \vec s(\psi_1) & \vec s(\psi_2) & \dots & \vec s(\psi_q) \\
    \end{bmatrix},
\end{equation}
\begin{equation}
    \label{eq:4.44}
    \vec s =
    \begin{bmatrix}
        1 & \exp{i\psi} & \dots & \exp\{ i(N-1)\psi\} \\
    \end{bmatrix}^T,
\end{equation}
\begin{equation}
    \label{eq:4.45}
    \vec a =
    \begin{bmatrix}
        0 & \dots & 0 & a & 0 & \dots 0 \\
    \end{bmatrix}^T,
\end{equation}

где $\vec w$ -- весовой вектор пользователя,
$\vec s(\psi)$ -- фазирующий вектор,
$N$ -- число элементов в антенной решетке,
$\vec \xi$ -- вектор шума,
$\vec z$ -- вектор комплексной амплитуды размерности $(Q\times 1)$,
где все элементы нулевые, кроме одного, отвечающему фактическому углу
прихода излучения на решетку.
Основная задача алгоритмов этого семейства -- восстановить вектор $\vec a$
используя количество измерений $L \ll Q$.  Если мы рассмотрим некоторую кодовую
книгу $\vec W$ размером $(N \times L)$, чьи столбцы являются весовыми векторами
для луча пользователя, результат сканирования будет
следующим
\begin{equation}
    \label{eq:4.46}
    y = \vec W^H\vec S \vec a + \vec \xi,
\end{equation}

В работе \cite{Alkhateeb2014}, авторы утверждают, что их адаптивный алгоритм более эффективен,
чем обычный алгоритм бисекций. В адаптивном алгоритме процедура зондирования разбита на несколько этапов
и кодовая книга $\vec W$ текущего этапа зависит от предыдущих результатов. Понятно, что если нас не интересует значение $a$, то
вектор $\vec a$ может быть сжат до вектора $\vec z$. Этот вектор кодирует позицию ненулевого элемента в векторе $\vec a$ (индекс $q$) и
требует только $\log(Q)$ итераций.

На первом шаге считаем, что ненулевой элемент имеет индекс от $1$ до $Q/2$ ($z_1=0$) или
$Q/2+1$ до $Q$ ($z_1=1$). Для этого нам необходимо сформировать кодовую книгу $\vec W$ размерности $(N \times 2)$, которая удовлетворяет условию
\begin{equation}
    \label{eq:4.47}
    \vec S^H \vec W = \alpha \vec G,
\end{equation}
\begin{equation}
    \label{eq:4.48}
    \vec G =
    \begin{pmatrix}
        1 & \dots & 1 & 0 & \dots & 0 \\
        0 & \dots & 0 & 1 & \dots & 1 \\
    \end{pmatrix}^T,
\end{equation}
где $\vec G$ -- матрица $(Q \times 2)$ и $\alpha$ -- нормировочный множитель.
Физически это означает, что первый весовой вектор должен обеспечивать однородную структуру ДН по
обобщенным углам $\psi_1 \dots \psi_{Q/2}$ и подавлять ДН в направлениях $\psi_{Q/2 + 1}\dots \psi_Q$. Второй весовой вектор должен обеспечивать противоположное распределение.
Приближенное решение для кодовой книги $\vec W$ получается следующим
\begin{equation}
    \label{eq:4.49}
    \vec W = \alpha (\vec S \vec S^H)^{-1} \vec S \vec G
\end{equation}

\begin{figure}[ht]
    \centering
    \includegraphics[width=0.5\linewidth]{figs/fig4.18}
    \caption{ДН для первого шага алгоритма $Q=40,~N=8$}
    \label{fig:4.18}
\end{figure}
Кодовый вектор, при котором будет принята наибольшая мощность будет соответствовать
первому приближению направления на источник. Пусть $z_1 = 0$. Тогда на следующим шаге
мы должны определить $z_2$. Это означает, что ненулевой элемент лежит между индексами $1$ или $Q/4$ ($z_2 =0 | z_1 =0$) или
между индексами $Q/4 + 1$ и $Q/2$ ($z_1 = 1 | z_1 = 0$). В этом случае матрица $\vec G$ определяется как
\begin{equation}
    \label{eq:4.50}
    \vec G =
    \begin{pmatrix}
        1 & \dots & 1 & 0 & \dots & 0 & 0 & \dots & 0 & 0 & \dots & 0 \\
        0 & \dots & 0 & 1 & \dots & 1 & 0 & \dots & 0 & 0 & \dots & 0 \\
    \end{pmatrix}^T.
\end{equation}
\begin{figure}[h!]
    \centering
    \includegraphics[width=0.5\linewidth]{figs/fig4.19}
    \caption{ДН для второго шага алгоритма, если $z_1=0$, $Q=40,~N=8$}
    \label{fig:4.19}
\end{figure}

Таким образом, ненулевые элементы в матрице $\vec G$ определяются сканированием необходимого индекса луча.
Процедура продолжается до тех пор, пока не будет определен последний элемент $z$. Проблема в том, что
с выбранной в данной работе аппаратной конфигурации пользователя мы не можем
применить \eqref{eq:4.49}, поскольку у нас не хватает степеней свободы, чтобы
обеспечить равномерное формирование направленности в одной области пространства
и полностью подавить другие. Поэтому, мы предлагаем некоторую модификацию этого алгоритма на основе дихотомии, следуя физическим принципам вышеизложенного.

\begin{enumerate}[label=\textbf{Шаг \arabic*:}]
    \item BS периодически переключает свои лучи, UE использует следующий весовой вектор $\vec w = \mqty*[1 & 0 & \dots & 0]^T$ для каждой AIP.
          Физически это означает, что отключаются все элементы АР, кроме одного. ДН всей решетки совпадает с ДН элемента и становится квазивсенаправленной.
          Выбирается та AIP, где результирующая измеренная мощность оказывается больше.
    \item BS периодически переключает свои лучи. Обозначим $\eta_{left} = - \pi$, $\eta_{right} = + \pi$.
          На стороне пользователя применяется следующая кодовая книга
          \begin{equation}
               \label{eq:4.51}
              \vec W =
              \begin{pmatrix}
                  \mqty{ 1 & \exp{i\eta_1}} & \zmat{1}{6} \\
                  \mqty{ 1 & \exp{i\eta_2}} & \zmat{1}{6} \\
              \end{pmatrix}
          \end{equation}
          \begin{equation}
              \eta_1 = \frac34 \eta_{left} + \frac14 \eta_{right}; ~ \eta_2 = \frac14 \eta_{left} + \frac34 \eta_{right}
          \end{equation}
          Если первый вектор бимформинга обеспечил наибольшую принятую мощность, то
          $\eta_{right} = 0.5 (\eta_{left} + \eta_{right})$.
          В другом случае
          $\eta_{left} = 0.5 (\eta_{left} + \eta_{right})$.
          
    \item BS периодически переключает свои лучи. Пользователь использует следующую кодовую книгу
          \begin{equation}
            \label{eq:4.53}
              \vec W =
              \begin{pmatrix}
                  \mqty{ 1 & \exp{i\eta_1} & \exp{i2\eta_1} & \exp{3i\eta_1}} & \zmat{1}{4} \\
                  \mqty{ 1 & \exp{i\eta_2} & \exp{i2\eta_2} & \exp{3i\eta_2}} & \zmat{1}{4} \\
              \end{pmatrix}
          \end{equation}
          \begin{equation}
              \eta_1 = \frac34 \eta_{left} + \frac14 \eta_{right}, ~ \eta_2 = \frac14 \eta_{left} + \frac34 \eta_{right}
          \end{equation}
          
          Если первый вектор бимформинга обеспечил наибольшую принятую мощность, то
          $\eta_{right} = 0.5 (\eta_{left} + \eta_{right})$.
          В другом случае
          $\eta_{left} = 0.5 (\eta_{left} + \eta_{right})$.
    \item BS периодически переключает свои лучи. Пользователь использует следующую кодовую книгу
          \begin{equation}
            \label{eq:4.55}
              \vec W =
              \begin{pmatrix}
                  1 & \exp{i\eta_1} & \exp{i2\eta_1} & \dots & \exp{i(N-1)\eta_1} \\
                  1 & \exp{i\eta_2} & \exp{i2\eta_2} & \dots & \exp{i(N-1)\eta_2}
              \end{pmatrix}
          \end{equation}
          \begin{equation}
              \eta_1 = \frac34 \eta_{left} + \frac14 \eta_{right}, ~ \eta_2 = \frac14 \eta_{left} + \frac34 \eta_{right}
          \end{equation}
          
          Если первый вектор бимформинга обеспечил наибольшую принятую мощность, то
          $\eta_{right} = 0.5 (\eta_{left} + \eta_{right})$.
          В другом случае
          $\eta_{left} = 0.5 (\eta_{left} + \eta_{right})$.
    \item Предыдущий шаг повторяется, пока не достигается желаемая точность. Отметим, что ширина ДН начиная с этого шага перестает меняться, изменяется только направление луча.
    \item Вычисляем угол прихода используя оцененный обобщенный угол $\hat \psi = 0.5 (\eta_{left} + \eta_{right})$. Если на шаге 1 была выбрана первая решетка, то
          $\hat \phi_{AOA} = \hat \phi$, в противном случае $\hat \phi_{AOA} = \hat \phi + \pi$.
\end{enumerate}
\begin{figure}[ht!]
\centering
\begin{subfigure}{0.49\linewidth}
    \centering
    \includegraphics[width=\linewidth]{figs/fig4.20}
    \caption{}
    \label{fig:4.20}
\end{subfigure}
\begin{subfigure}{0.49\linewidth}
    \centering
    \includegraphics[width=\linewidth]{figs/fig4.21}
    \caption{}
    \label{fig:4.21}
\end{subfigure}
\begin{subfigure}{0.49\linewidth}
    \centering
    \includegraphics[width=\linewidth]{figs/fig4.22}
    \caption{}
    \label{fig:4.22}
\end{subfigure}
\caption{Диаграммы направленности, формируемые кодовыми книгами 
(\subref{fig:4.20}) -- \eqref{eq:4.51};
(\subref{fig:4.21}) -- \eqref{eq:4.53};
(\subref{fig:4.22}) -- \eqref{eq:4.55};
}
\label{fig:4.21-full}
\end{figure}

Временн\'{а}я структура метода бисекций (\textit{Compressed Sensing}) представлена на рис. \ref{fig:4.23}.
Параметры алгоритма представлены в табл. \ref{tab:4.5}.
\begin{table}[H]
    \centering
    \caption{Параметры метода бисекций}
    \label{tab:4.5}
    \begin{tabular}{lcc}
        \toprule
        \midrule
        Число уровней / Q (для одной АР)              & 8 / 128 & 8 / 128 \\
        Число просканированных \newline лучей (UE/BS) & 16 / 64 & 16 / 8  \\
        Суммарное число RS                            & 1024    & 128     \\
        Необходимое время (слот 0.125 мс)             & 304 мс  & 32 мс   \\
        \bottomrule
    \end{tabular}
\end{table}
\begin{figure}[H]
    \centering
    \includegraphics[width=\linewidth]{figs/fig4.23}
    \caption{Временная структура алгоритма \ACS{}}
    \label{fig:4.23}
\end{figure}
